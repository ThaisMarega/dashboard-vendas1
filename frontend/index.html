<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard de Vendas - Imagem Modas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      :root {
        --verde: #5b6240;
        --bege: #f4f1ea;
        --dourado: #c7a15a;
        --texto: #333333;
        --bordas: #e0ddd5;
        --erro: #b3261e;
        --sucesso: #1b873f;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(
            circle at top,
            #ffffff 0,
            #ece7dd 45%,
            #d9d2c4 100%
          );
        color: var(--texto);
      }

      .layout {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px 16px 40px;
      }

      header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 24px;
      }

      header img {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid rgba(0, 0, 0, 0.08);
      }

      header .marca {
        font-size: 14px;
        letter-spacing: 0.26em;
        text-transform: uppercase;
        color: #555;
      }

      header .sub {
        font-size: 12px;
        letter-spacing: 0.25em;
        text-transform: uppercase;
        color: #888;
        margin-top: 2px;
      }

      .status-bar {
        margin-bottom: 16px;
        font-size: 13px;
        padding: 10px 12px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.75);
        border: 1px solid rgba(0, 0, 0, 0.06);
        backdrop-filter: blur(8px);
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--verde);
      }

      .status-bar.erro {
        color: var(--erro);
        border-color: #f4c7c3;
        background: #fff5f5;
      }

      .status-bar.erro .status-dot {
        background: var(--erro);
      }

      .status-bar.sucesso {
        color: var(--sucesso);
      }

      .status-bar.sucesso .status-dot {
        background: var(--sucesso);
      }

      .grid {
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.4fr);
        gap: 20px;
      }

      @media (max-width: 900px) {
        .grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .card {
        background: rgba(255, 255, 255, 0.92);
        border-radius: 18px;
        padding: 18px 18px 20px;
        box-shadow: 0 14px 40px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
      }

      .card-title {
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 4px;
        letter-spacing: 0.07em;
        text-transform: uppercase;
      }

      .card-subtitle {
        font-size: 12px;
        color: #777;
        margin-bottom: 14px;
      }

      label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #555;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid var(--bordas);
        font-size: 14px;
        outline: none;
        background: rgba(255, 255, 255, 0.9);
      }

      input:focus,
      select:focus,
      textarea:focus {
        border-color: var(--verde);
        box-shadow: 0 0 0 1px rgba(91, 98, 64, 0.4);
      }

      textarea {
        resize: vertical;
        min-height: 60px;
      }

      .field {
        margin-bottom: 10px;
      }

      .row {
        display: flex;
        gap: 10px;
      }

      .row > .field {
        flex: 1;
      }

      button {
        padding: 8px 14px;
        border-radius: 999px;
        border: none;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        letter-spacing: 0.06em;
        text-transform: uppercase;
      }

      .btn-primary {
        background: var(--verde);
        color: #fff;
      }

      .btn-outline {
        background: transparent;
        border: 1px solid var(--verde);
        color: var(--verde);
      }

      .btn-danger {
        background: #faf0f0;
        color: var(--erro);
        border: 1px solid #f2c7c4;
        padding: 5px 10px;
        font-size: 11px;
      }

      .small {
        font-size: 12px;
        color: #777;
      }

      .tabs {
        display: flex;
        gap: 6px;
        margin-bottom: 12px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      }

      .tab {
        padding: 8px 12px;
        border-radius: 999px 999px 0 0;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        color: #666;
      }

      .tab.active {
        background: #ffffff;
        color: #111;
        border: 1px solid rgba(0, 0, 0, 0.06);
        border-bottom-color: #ffffff;
      }

      .tab-content {
        padding-top: 4px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      th,
      td {
        padding: 6px 4px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.04);
        text-align: left;
      }

      th {
        font-weight: 600;
        color: #666;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .meta-chip {
        font-size: 11px;
        padding: 4px 9px;
        border-radius: 999px;
        background: #fff9e6;
        border: 1px solid #f2e0a5;
        color: #8a6b1f;
      }

      #painel {
        display: none;
      }

      #loginCard {
        max-width: 420px;
      }

      @media (max-width: 600px) {
        header {
          flex-direction: column;
          align-items: flex-start;
        }

        .status-bar {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <header>
        <img
          src="001 LOGO_Prancheta 1 cópia 27.png"
          alt="Logo Imagem Modas"
        />
        <div>
          <div class="marca">IMAGEM MODAS</div>
          <div class="sub">Dashboard de vendas</div>
        </div>
      </header>

      <div id="statusContainer" class="status-bar">
        <span class="status-dot"></span>
        <span id="statusText">Faça login para começar o dia.</span>
      </div>

      <!-- LOGIN -->
      <div id="loginCard" class="card">
        <div class="card-title">Login da vendedora</div>
        <div class="card-subtitle">
          Acesso exclusivo para vendedoras Imagem Modas.
        </div>

        <div class="field">
          <label for="nome">Nome da vendedora</label>
          <input id="nome" value="" autocomplete="username" />
        </div>

        <div class="field">
          <label for="senha">Senha</label>
          <input
            id="senha"
            type="password"
            autocomplete="current-password"
          />
        </div>

        <button class="btn-primary" onclick="login()">Entrar</button>

        <div style="margin-top: 10px; font-size: 12px; text-align: center;">
          <a href="gerente.html" style="color: #5b6240; font-weight: 600;">
            Acesso da Gerente
          </a>
        </div>
      </div>

      <!-- PAINEL APÓS LOGIN -->
      <div id="painel" class="grid" style="display:none;">
        <!-- Coluna esquerda: resumo + atendimentos/meta -->
        <div class="card">
          <div class="card-title" id="bemVindaTitulo">Bom dia</div>
          <div class="card-subtitle small" id="infoHoje"></div>

          <div class="field">
            <label for="dataPainel">Dia</label>
            <input
              id="dataPainel"
              type="date"
              onchange="alterarDataPainel(this.value)"
            />
            <div class="small">
              Escolha outro dia para ver seu histórico de metas, atendimentos e
              vendas.
            </div>
          </div>

          <!-- META DIÁRIA -->
          <div class="field">
            <label>Meta de hoje</label>
            <div class="row">
              <div class="field">
                <input
                  id="metaValor"
                  type="number"
                  min="0"
                  step="0.01"
                  placeholder="R$ 0,00"
                />
              </div>
              <button class="btn-outline" onclick="salvarMetaHoje()">
                Salvar meta
              </button>
            </div>
            <div class="small">
              Meta atual: <span id="metaAtual" class="meta-chip">—</span>
            </div>
            <div class="small" style="margin-top:6px;">
              Meta mensal: <span id="metaMensalChip" class="meta-chip">—</span>
            </div>
            <div class="small" style="margin-top:6px;">
              Falta para o mês:
              <span id="faltanteMensalChip" class="meta-chip">—</span>
            </div>
          </div>

          <hr style="border: none; border-top: 1px solid #eee; margin: 16px 0" />

          <!-- ATENDIMENTOS -->
          <div>
            <div class="card-title" style="font-size: 13px">Atendimentos</div>
            <div class="card-subtitle small">
              Quantos clientes você atendeu hoje (presencial, WhatsApp,
              Instagram, etc).
            </div>

            <div class="row">
              <div class="field">
                <label for="atendimentosQtd">Atendimentos do dia</label>
                <input
                  id="atendimentosQtd"
                  type="number"
                  min="0"
                  step="1"
                  placeholder="0"
                />
              </div>
              <button class="btn-outline" onclick="salvarAtendimentosHoje()">
                Salvar
              </button>
            </div>

            <div class="small" style="margin-top:10px;">
              Taxa de conversão: <span id="taxaConversaoSpan">0%</span>
            </div>
            <div class="small">
              Ticket médio: <span id="ticketMedioSpan">R$ 0,00</span>
            </div>
            <div class="small" id="pecasPorVendaLinha">
              Peças por venda: 0,0
            </div>
          </div>
        </div>

        <!-- Coluna direita: abas Vendas / Condicionais -->
        <div class="card">
          <div class="tabs">
            <div
              class="tab active"
              id="tabVendas"
              onclick="abrirAba('vendas')"
            >
              Vendas
            </div>
            <div
              class="tab"
              id="tabCondicionais"
              onclick="abrirAba('condicionais')"
            >
              Condicionais
            </div>
          </div>

          <div class="tab-content">
            <!-- ABA VENDAS -->
            <div id="abaVendas">
              <div class="card-subtitle">
                Lance as vendas do dia e acompanhe ticket médio, conversão e
                peças por venda.
              </div>

              <div class="row">
                <div class="field">
                  <label for="valorVenda">Valor (R$)</label>
                  <input
                    id="valorVenda"
                    type="number"
                    min="0"
                    step="0.01"
                    placeholder="0,00"
                  />
                </div>

                <div class="field">
                  <label for="qtdPecasVenda">Qtd. peças</label>
                  <input
                    id="qtdPecasVenda"
                    type="number"
                    min="1"
                    step="1"
                    placeholder="0"
                  />
                </div>

                <div class="field">
                  <label for="formaPagamento">Forma de pagamento</label>
                  <select id="formaPagamento">
                    <option value="">Selecione</option>

                    <optgroup label="À vista">
                      <option value="dinheiro">Dinheiro</option>
                      <option value="pix">PIX</option>
                      <option value="debito">Débito</option>
                    </optgroup>

                    <optgroup label="Crédito">
                      <option value="credito_1x">Crédito 1x</option>
                      <option value="credito_2x">Crédito 2x</option>
                      <option value="credito_3x">Crédito 3x</option>
                      <option value="credito_4x">Crédito 4x</option>
                      <option value="credito_5x">Crédito 5x</option>
                      <option value="credito_6x">Crédito 6x</option>
                      <option value="credito_7x">Crédito 7x</option>
                      <option value="credito_8x">Crédito 8x</option>
                      <option value="credito_9x">Crédito 9x</option>
                      <option value="credito_10x">Crédito 10x</option>
                    </optgroup>

                    <optgroup label="Crediário">
                      <option value="crediario_1x">Crediário 1x</option>
                      <option value="crediario_2x">Crediário 2x</option>
                      <option value="crediario_3x">Crediário 3x</option>
                      <option value="crediario_4x">Crediário 4x</option>
                      <option value="crediario_5x">Crediário 5x</option>
                      <option value="crediario_6x">Crediário 6x</option>
                    </optgroup>

                    <optgroup label="Boleto">
                      <option value="boleto_1x">Boleto 1x</option>
                      <option value="boleto_2x">Boleto 2x</option>
                      <option value="boleto_3x">Boleto 3x</option>
                      <option value="boleto_4x">Boleto 4x</option>
                      <option value="boleto_5x">Boleto 5x</option>
                      <option value="boleto_6x">Boleto 6x</option>
                      <option value="boleto_7x">Boleto 7x</option>
                      <option value="boleto_8x">Boleto 8x</option>
                    </optgroup>

                    <optgroup label="Cheque pré">
                      <option value="cheque_1x">Cheque pré 1x</option>
                      <option value="cheque_2x">Cheque pré 2x</option>
                      <option value="cheque_3x">Cheque pré 3x</option>
                      <option value="cheque_4x">Cheque pré 4x</option>
                      <option value="cheque_5x">Cheque pré 5x</option>
                      <option value="cheque_6x">Cheque pré 6x</option>
                    </optgroup>
                  </select>
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label for="clienteNome">Nome da cliente</label>
                  <input
                    id="clienteNome"
                    type="text"
                    placeholder="Opcional"
                  />
                </div>
              </div>

              <div class="field">
                <label for="obsVenda">Observação</label>
                <textarea
                  id="obsVenda"
                  placeholder="Ex: look completo, quem indicou, peça-chave..."
                ></textarea>
              </div>

              <button class="btn-primary" onclick="lançarVenda()">
                Lançar venda
              </button>

              <div
                class="card-subtitle"
                style="margin-top: 14px; margin-bottom: 6px"
              >
                Vendas do dia selecionado
              </div>
              <div class="small" id="resumoVendasHoje">Nenhuma venda ainda.</div>

              <div style="max-height: 220px; overflow-y: auto; margin-top: 6px">
                <table id="tabelaVendas">
                  <thead>
                    <tr>
                      <th>Horário</th>
                      <th>Cliente</th>
                      <th>Forma</th>
                      <th>Peças</th>
                      <th>Valor</th>
                      <th>Ações</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <!-- ABA CONDICIONAIS -->
            <div id="abaCondicionais" style="display:none;">
              <div class="card-subtitle">
                Controle das peças que saem em condicional.
              </div>

              <div class="row">
                <div class="field">
                  <label for="qtdPecas">Qtd. de peças</label>
                  <input
                    id="qtdPecas"
                    type="number"
                    min="1"
                    step="1"
                    placeholder="0"
                  />
                </div>

                <div class="field">
                  <label for="valorCondicional">Valor total (R$)</label>
                  <input
                    id="valorCondicional"
                    type="number"
                    min="0"
                    step="0.01"
                    placeholder="0,00"
                  />
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label for="clienteCondicional">Cliente</label>
                  <input
                    id="clienteCondicional"
                    type="text"
                    placeholder="Nome da cliente"
                  />
                </div>
              </div>

              <div class="field">
                <label for="obsCondicional">Observação</label>
                <textarea
                  id="obsCondicional"
                  placeholder="Prazo de retorno, peças principais, etc."
                ></textarea>
              </div>

              <button class="btn-primary" onclick="lançarCondicional()">
                Lançar condicional
              </button>

              <div
                class="card-subtitle"
                style="margin-top: 14px; margin-bottom: 6px"
              >
                Condicionais em aberto
              </div>

              <div style="max-height: 220px; overflow-y: auto; margin-top: 6px">
                <table id="tabelaCondicionais">
                  <thead>
                    <tr>
                      <th>Data</th>
                      <th>Cliente</th>
                      <th>Peças</th>
                      <th>Valor</th>
                      <th>Ações</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <script>
        const API = "https://dashboard-vendas1.onrender.com/api";
        let token = null;
        let nomeVendedora = null;

        // data exibida no painel (começa em hoje)
        let dataPainel = null;

        // indicadores
        let vendasHojeQtd = 0;
        let vendasHojeTotal = 0;
        let atendimentosHojeQtd = 0;

        function hojeISO() {
          return new Date().toISOString().slice(0, 10);
        }

        function setStatus(msg, tipo) {
          const bar = document.getElementById("statusContainer");
          const text = document.getElementById("statusText");
          text.textContent = msg;
          bar.classList.remove("erro", "sucesso");
          if (tipo === "erro") bar.classList.add("erro");
          if (tipo === "sucesso") bar.classList.add("sucesso");
        }

        function abrirAba(qual) {
          const abaVendas = document.getElementById("abaVendas");
          const abaCond = document.getElementById("abaCondicionais");
          const tabV = document.getElementById("tabVendas");
          const tabC = document.getElementById("tabCondicionais");

          if (qual === "vendas") {
            abaVendas.style.display = "block";
            abaCond.style.display = "none";
            tabV.classList.add("active");
            tabC.classList.remove("active");
          } else {
            abaVendas.style.display = "none";
            abaCond.style.display = "block";
            tabV.classList.remove("active");
            tabC.classList.add("active");
          }
        }

        function atualizarIndicadoresVenda() {
          const ticketSpan = document.getElementById("ticketMedioSpan");
          const taxaSpan = document.getElementById("taxaConversaoSpan");

          const ticket = vendasHojeQtd ? vendasHojeTotal / vendasHojeQtd : 0;
          if (ticketSpan) {
            ticketSpan.textContent = "R$ " + ticket.toFixed(2);
          }

          let taxa = 0;
          if (atendimentosHojeQtd && vendasHojeQtd) {
            taxa = (vendasHojeQtd / atendimentosHojeQtd) * 100;
          }
          if (taxaSpan) {
            taxaSpan.textContent =
              taxa.toFixed(1).replace(".", ",") + "%";
          }
        }

        function authHeaders() {
          return {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          };
        }

        // LOGIN
        async function login() {
          const nome = document.getElementById("nome").value.trim();
          const senha = document.getElementById("senha").value;

          if (!nome || !senha) {
            setStatus("Preencha nome e senha para entrar.", "erro");
            return;
          }

          setStatus("Conectando...", null);

          try {
            const resp = await fetch(API + "/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ nome, senha }),
            });

            if (!resp.ok) {
              setStatus("Falha no login. Confira nome e senha.", "erro");
              return;
            }

            const data = await resp.json();
            token = data.token;
            nomeVendedora = data.vendedora?.nome || nome;

            document.getElementById("loginCard").style.display = "none";
            document.getElementById("painel").style.display = "grid";

            // define dia padrão
            dataPainel = hojeISO();
            const inputData = document.getElementById("dataPainel");
            if (inputData) inputData.value = dataPainel;

            atualizarDataCabecalho();

            setStatus(`Logada como ${nomeVendedora}. Bom trabalho!`, "sucesso");

            await carregarTudoVendedora();
          } catch (e) {
            console.error(e);
            setStatus("Erro ao conectar com o servidor.", "erro");
          }
        }

        function atualizarDataCabecalho() {
          if (!dataPainel) dataPainel = hojeISO();
          const d = new Date(dataPainel + "T12:00:00");
          const texto = d.toLocaleDateString("pt-BR", {
            weekday: "long",
            day: "2-digit",
            month: "long",
            year: "numeric",
          });

          document.getElementById("bemVindaTitulo").textContent =
            "Bom dia, " + (nomeVendedora || "");
          document.getElementById("infoHoje").textContent =
            texto.charAt(0).toUpperCase() + texto.slice(1);
        }

        async function alterarDataPainel(novaData) {
          dataPainel = novaData || hojeISO();

          const inputData = document.getElementById("dataPainel");
          if (inputData && !novaData) {
            inputData.value = dataPainel;
          }

          atualizarDataCabecalho();
          setStatus("Carregando dados do dia selecionado...", null);
          await carregarTudoVendedora();
          setStatus("Dados atualizados para o dia selecionado.", "sucesso");
        }

        async function carregarTudoVendedora() {
          await Promise.all([
            carregarMetaHoje(dataPainel),
            carregarAtendimentosHoje(dataPainel),
            carregarVendasHoje(dataPainel),
            carregarCondicionais(),
          ]);
        }

        // META DIÁRIA + MENSAL (usando /api/metas/:data)
        async function carregarMetaHoje(dataRef) {
          if (!token) return;
          const data = dataRef || hojeISO();

          try {
            const resp = await fetch(API + "/metas/" + data, {
              headers: { Authorization: "Bearer " + token },
            });
            const meta = await resp.json();

            const valorDia = Number(meta.valor_meta || meta.valorMeta || 0);
            const metaMensal = Number(meta.meta_mensal || 0);
            const faltaMes = Number(meta.falta_no_mes || 0);

            document.getElementById("metaAtual").textContent =
              "R$ " + valorDia.toFixed(2);
            document.getElementById("metaValor").value =
              valorDia > 0 ? valorDia.toString() : "";

            const metaMensalChip = document.getElementById("metaMensalChip");
            const faltanteMensalChip =
              document.getElementById("faltanteMensalChip");

            if (metaMensalChip) {
              metaMensalChip.textContent = "R$ " + metaMensal.toFixed(2);
            }
            if (faltanteMensalChip) {
              faltanteMensalChip.textContent = "R$ " + faltaMes.toFixed(2);
            }
          } catch (e) {
            console.error(e);
            setStatus("Erro ao buscar meta.", "erro");
          }
        }

        async function salvarMetaHoje() {
          if (!token) return;
          const valor = Number(
            (document.getElementById("metaValor").value || "0").replace(
              ",",
              "."
            )
          );
          const data = dataPainel || hojeISO();

          try {
            const resp = await fetch(API + "/metas", {
              method: "POST",
              headers: authHeaders(),
              body: JSON.stringify({ valorMeta: valor, data }),
            });

            if (!resp.ok) {
              setStatus("Não foi possível salvar a meta.", "erro");
              return;
            }

            await carregarMetaHoje(data);
            setStatus("Meta do dia atualizada.", "sucesso");
          } catch (e) {
            console.error(e);
            setStatus("Erro ao salvar meta.", "erro");
          }
        }

        // ATENDIMENTOS
        async function carregarAtendimentosHoje(dataRef) {
          if (!token) return;
          const data = dataRef || hojeISO();

          try {
            const resp = await fetch(API + "/atendimentos/" + data, {
              headers: { Authorization: "Bearer " + token },
            });
            const dados = await resp.json();
            const qtd = Number(dados.quantidade || 0);

            document.getElementById("atendimentosQtd").value = qtd;
            atendimentosHojeQtd = qtd;
            atualizarIndicadoresVenda();
          } catch (e) {
            console.error(e);
            setStatus("Erro ao buscar atendimentos.", "erro");
          }
        }

        async function salvarAtendimentosHoje() {
          if (!token) return;
          const quantidade = Number(
            document.getElementById("atendimentosQtd").value || "0"
          );
          const data = dataPainel || hojeISO();

          try {
            const resp = await fetch(API + "/atendimentos", {
              method: "POST",
              headers: authHeaders(),
              body: JSON.stringify({ quantidade, data }),
            });

            if (!resp.ok) {
              setStatus("Não foi possível salvar atendimentos.", "erro");
              return;
            }

            await carregarAtendimentosHoje(data);
            setStatus("Atendimentos salvos.", "sucesso");
          } catch (e) {
            console.error(e);
            setStatus("Erro ao salvar atendimentos.", "erro");
          }
        }

        // VENDAS
        async function carregarVendasHoje(dataRef) {
          if (!token) return;
          const dia = dataRef || hojeISO();

          const url =
            API +
            `/vendas?dataInicio=${encodeURIComponent(
              dia
            )}&dataFim=${encodeURIComponent(dia)}`;

          try {
            const resp = await fetch(url, {
              headers: { Authorization: "Bearer " + token },
            });
            const vendas = await resp.json();

            const tbody = document.querySelector("#tabelaVendas tbody");
            tbody.innerHTML = "";

            let total = 0;
            let totalPecas = 0;

            vendas.forEach((v) => {
              const tr = document.createElement("tr");
              const dataVenda = v.data_venda || v.datavenda || v.data;
              const hora = dataVenda
                ? new Date(dataVenda).toLocaleTimeString("pt-BR", {
                    hour: "2-digit",
                    minute: "2-digit",
                  })
                : "-";

              const pecas = Number(
                v.quantidade_pecas || v.quantidadePecas || 0
              );

              total += Number(v.valor || 0);
              totalPecas += pecas;

              tr.innerHTML = `
                <td>${hora}</td>
                <td>${v.cliente_nome || v.clienteNome || "-"}</td>
                <td>${v.forma_pagamento || v.formaPagamento || "-"}</td>
                <td>${pecas || "-"}</td>
                <td>R$ ${Number(v.valor || 0).toFixed(2)}</td>
                <td>
                  <button
                    class="btn-danger"
                    onclick="excluirVenda(${v.id})"
                  >
                    Remover
                  </button>
                  <button
                    class="btn-outline"
                    style="padding:4px 8px; font-size:10px; margin-top:4px;"
                    onclick="editarVenda(${v.id}, ${Number(
                v.valor || 0
              )}, ${pecas || 0})"
                  >
                    Editar
                  </button>
                </td>
              `;
              tbody.appendChild(tr);
            });

            vendasHojeQtd = vendas.length;
            vendasHojeTotal = total;

            if (vendas.length === 0) {
              document.getElementById("resumoVendasHoje").textContent =
                "Nenhuma venda lançada neste dia.";
            } else {
              document.getElementById(
                "resumoVendasHoje"
              ).textContent = `${vendas.length} venda(s) • Total R$ ${total.toFixed(
                2
              )}`;
            }

            // peças por venda
            const pecasPorVenda =
              vendasHojeQtd > 0 ? totalPecas / vendasHojeQtd : 0;
            const pecasLinha = document.getElementById("pecasPorVendaLinha");
            if (pecasLinha) {
              pecasLinha.textContent =
                "Peças por venda: " +
                pecasPorVenda.toFixed(1).replace(".", ",");
            }

            atualizarIndicadoresVenda();
          } catch (e) {
            console.error(e);
            setStatus("Erro ao buscar vendas.", "erro");
          }
        }

        async function lançarVenda() {
          if (!token) return;

          const valor = Number(
            (document.getElementById("valorVenda").value || "0").replace(
              ",",
              "."
            )
          );
          const quantidadePecas = Number(
            document.getElementById("qtdPecasVenda").value || "0"
          );
          const formaPagamento =
            document.getElementById("formaPagamento").value;
          const clienteNome = document
            .getElementById("clienteNome")
            .value.trim();
          const observacao = document
            .getElementById("obsVenda")
            .value.trim();

          if (!valor || !formaPagamento) {
            setStatus(
              "Informe pelo menos o valor e a forma de pagamento.",
              "erro"
            );
            return;
          }

          try {
            const resp = await fetch(API + "/vendas", {
              method: "POST",
              headers: authHeaders(),
              body: JSON.stringify({
                valor,
                quantidadePecas,
                formaPagamento,
                clienteNome,
                observacao,
              }),
            });

            if (!resp.ok) {
              setStatus("Não foi possível lançar a venda.", "erro");
              return;
            }

            document.getElementById("valorVenda").value = "";
            document.getElementById("qtdPecasVenda").value = "";
            document.getElementById("formaPagamento").value = "";
            document.getElementById("clienteNome").value = "";
            document.getElementById("obsVenda").value = "";

            setStatus("Venda lançada com sucesso.", "sucesso");
            await carregarVendasHoje(dataPainel);
            await carregarMetaHoje(dataPainel);
          } catch (e) {
            console.error(e);
            setStatus("Erro ao lançar venda.", "erro");
          }
        }

        // CONDICIONAIS
        async function carregarCondicionais() {
          if (!token) return;

          try {
            const resp = await fetch(API + "/condicionais", {
              headers: { Authorization: "Bearer " + token },
            });
            const conds = await resp.json();

            const tbody = document.querySelector(
              "#tabelaCondicionais tbody"
            );
            tbody.innerHTML = "";

            conds.forEach((c) => {
              const tr = document.createElement("tr");
              const dataReg = c.data_registro || c.dataRegistro;
              const data = dataReg
                ? new Date(dataReg).toLocaleDateString("pt-BR")
                : "-";

              const pecas = Number(
                c.quantidade_pecas || c.quantidadePecas || 0
              );
              const valor = Number(
                c.valor_total || c.valorTotal || 0
              );

              tr.innerHTML = `
                <td>${data}</td>
                <td>${c.cliente_nome || c.clienteNome || "-"}</td>
                <td>${pecas}</td>
                <td>R$ ${valor.toFixed(2)}</td>
                <td>
                  <button
                    class="btn-danger"
                    onclick="excluirCondicional(${c.id})"
                  >
                    Remover
                  </button>
                  <button
                    class="btn-outline"
                    style="padding:4px 8px; font-size:10px; margin-top:4px;"
                    onclick="editarCondicional(${c.id}, ${pecas}, ${valor})"
                  >
                    Editar
                  </button>
                </td>
              `;
              tbody.appendChild(tr);
            });
          } catch (e) {
            console.error(e);
            setStatus("Erro ao buscar condicionais.", "erro");
          }
        }

        async function lançarCondicional() {
          if (!token) return;

          const quantidadePecas = Number(
            document.getElementById("qtdPecas").value || "0"
          );
          const valorTotal = Number(
            (document.getElementById("valorCondicional").value || "0").replace(
              ",",
              "."
            )
          );
          const clienteNome = document
            .getElementById("clienteCondicional")
            .value.trim();
          const observacao = document
            .getElementById("obsCondicional")
            .value.trim();

          if (!quantidadePecas || !clienteNome) {
            setStatus(
              "Informe ao menos a quantidade de peças e o nome da cliente.",
              "erro"
            );
            return;
          }

          try {
            const resp = await fetch(API + "/condicionais", {
              method: "POST",
              headers: authHeaders(),
              body: JSON.stringify({
                quantidadePecas,
                valorTotal,
                clienteNome,
                observacao,
              }),
            });

            if (!resp.ok) {
              setStatus("Não foi possível lançar o condicional.", "erro");
              return;
            }

            document.getElementById("qtdPecas").value = "";
            document.getElementById("valorCondicional").value = "";
            document.getElementById("clienteCondicional").value = "";
            document.getElementById("obsCondicional").value = "";

            setStatus("Condicional lançado com sucesso.", "sucesso");
            await carregarCondicionais();
          } catch (e) {
            console.error(e);
            setStatus("Erro ao lançar condicional.", "erro");
          }
        }

        // ====== EDIÇÃO / EXCLUSÃO VENDAS E CONDICIONAIS ======

        async function excluirVenda(id) {
          if (!token) return;
          if (!confirm("Remover esta venda?")) return;

          try {
            const resp = await fetch(API + "/vendas/" + id, {
              method: "DELETE",
              headers: { Authorization: "Bearer " + token },
            });

            if (!resp.ok) {
              setStatus("Não foi possível remover a venda.", "erro");
              return;
            }

            setStatus("Venda removida.", "sucesso");
            await carregarVendasHoje(dataPainel);
            await carregarMetaHoje(dataPainel);
          } catch (e) {
            console.error(e);
            setStatus("Erro ao remover venda.", "erro");
          }
        }

        async function editarVenda(id, valorAtual, pecasAtual) {
          if (!token) return;

          const novoValorStr = prompt(
            "Novo valor da venda (R$):",
            valorAtual.toFixed(2)
          );
          if (novoValorStr === null) return;
          const novoValor = Number(
            novoValorStr.toString().replace(",", ".")
          );
          if (!novoValor || novoValor <= 0) {
            alert("Valor inválido.");
            return;
          }

          const novasPecasStr = prompt(
            "Nova quantidade de peças:",
            pecasAtual || 1
          );
          if (novasPecasStr === null) return;
          const novasPecas = parseInt(novasPecasStr, 10) || 1;

          try {
            const resp = await fetch(API + "/vendas/" + id, {
              method: "PUT",
              headers: authHeaders(),
              body: JSON.stringify({
                valor: novoValor,
                quantidadePecas: novasPecas,
              }),
            });

            if (!resp.ok) {
              setStatus("Não foi possível editar a venda.", "erro");
              return;
            }

            setStatus("Venda atualizada.", "sucesso");
            await carregarVendasHoje(dataPainel);
            await carregarMetaHoje(dataPainel);
          } catch (e) {
            console.error(e);
            setStatus("Erro ao editar venda.", "erro");
          }
        }

        async function excluirCondicional(id) {
          if (!token) return;
          if (!confirm("Remover este condicional?")) return;

          try {
            const resp = await fetch(API + "/condicionais/" + id, {
              method: "DELETE",
              headers: { Authorization: "Bearer " + token },
            });

            if (!resp.ok) {
              setStatus("Não foi possível remover o condicional.", "erro");
              return;
            }

            setStatus("Condicional removido.", "sucesso");
            await carregarCondicionais();
          } catch (e) {
            console.error(e);
            setStatus("Erro ao remover condicional.", "erro");
          }
        }

        async function editarCondicional(id, pecasAtual, valorAtual) {
          if (!token) return;

          const novasPecasStr = prompt(
            "Nova quantidade de peças:",
            pecasAtual || 1
          );
          if (novasPecasStr === null) return;
          const novasPecas = parseInt(novasPecasStr, 10) || 1;

          const novoValorStr = prompt(
            "Novo valor total (R$):",
            valorAtual.toFixed(2)
          );
          if (novoValorStr === null) return;
          const novoValor = Number(
            novoValorStr.toString().replace(",", ".")
          );
          if (!novoValor || novoValor < 0) {
            alert("Valor inválido.");
            return;
          }

          try {
            const resp = await fetch(API + "/condicionais/" + id, {
              method: "PUT",
              headers: authHeaders(),
              body: JSON.stringify({
                quantidadePecas: novasPecas,
                valorTotal: novoValor,
              }),
            });

            if (!resp.ok) {
              setStatus("Não foi possível editar o condicional.", "erro");
              return;
            }

            setStatus("Condicional atualizado.", "sucesso");
            await carregarCondicionais();
          } catch (e) {
            console.error(e);
            setStatus("Erro ao editar condicional.", "erro");
          }
        }
      </script>
    </div>
  </body>
</html>
