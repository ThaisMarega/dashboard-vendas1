<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard de Vendas - Imagem Modas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      :root {
        --verde: #5b6240;
        --bege: #f4f1ea;
        --dourado: #c7a15a;
        --texto: #333333;
        --bordas: #e0ddd5;
        --erro: #b3261e;
        --sucesso: #1b873f;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(
            circle at top,
            #ffffff 0,
            #ece7dd 45%,
            #d9d2c4 100%
          );
        color: var(--texto);
      }

      .layout {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px 16px 40px;
      }

      header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 24px;
      }

      header img {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid rgba(0, 0, 0, 0.08);
      }

      header .marca {
        font-size: 14px;
        letter-spacing: 0.26em;
        text-transform: uppercase;
        color: #555;
      }

      header .sub {
        font-size: 12px;
        letter-spacing: 0.25em;
        text-transform: uppercase;
        color: #888;
        margin-top: 2px;
      }

      .status-bar {
        margin-bottom: 16px;
        font-size: 13px;
        padding: 10px 12px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.75);
        border: 1px solid rgba(0, 0, 0, 0.06);
        backdrop-filter: blur(8px);
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--verde);
      }

      .status-bar.erro {
        color: var(--erro);
        border-color: #f4c7c3;
        background: #fff5f5;
      }

      .status-bar.erro .status-dot {
        background: var(--erro);
      }

      .status-bar.sucesso {
        color: var(--sucesso);
      }

      .status-bar.sucesso .status-dot {
        background: var(--sucesso);
      }

      .grid {
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.4fr);
        gap: 20px;
      }

      @media (max-width: 900px) {
        .grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .card {
        background: rgba(255, 255, 255, 0.92);
        border-radius: 18px;
        padding: 18px 18px 20px;
        box-shadow: 0 14px 40px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
      }

      .card-title {
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 4px;
        letter-spacing: 0.07em;
        text-transform: uppercase;
      }

      .card-subtitle {
        font-size: 12px;
        color: #777;
        margin-bottom: 14px;
      }

      label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #555;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid var(--bordas);
        font-size: 14px;
        outline: none;
        background: rgba(255, 255, 255, 0.9);
      }

      input:focus,
      select:focus,
      textarea:focus {
        border-color: var(--verde);
        box-shadow: 0 0 0 1px rgba(91, 98, 64, 0.4);
      }

      textarea {
        resize: vertical;
        min-height: 60px;
      }

      .field {
        margin-bottom: 10px;
      }

      .row {
        display: flex;
        gap: 10px;
      }

      .row > .field {
        flex: 1;
      }

      button {
        padding: 8px 14px;
        border-radius: 999px;
        border: none;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        letter-spacing: 0.06em;
        text-transform: uppercase;
      }

      .btn-primary {
        background: var(--verde);
        color: #fff;
      }

      .btn-outline {
        background: transparent;
        border: 1px solid var(--verde);
        color: var(--verde);
      }

      .btn-danger {
        background: #faf0f0;
        color: var(--erro);
        border: 1px solid #f2c7c4;
        padding: 5px 10px;
        font-size: 11px;
      }

      .small {
        font-size: 12px;
        color: #777;
      }

      .tabs {
        display: flex;
        gap: 6px;
        margin-bottom: 12px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      }

      .tab {
        padding: 8px 12px;
        border-radius: 999px 999px 0 0;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        color: #666;
      }

      .tab.active {
        background: #ffffff;
        color: #111;
        border: 1px solid rgba(0, 0, 0, 0.06);
        border-bottom-color: #ffffff;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      th,
      td {
        padding: 6px 4px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.04);
        text-align: left;
      }

      th {
        font-weight: 600;
        color: #666;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        padding: 3px 8px;
        border-radius: 999px;
        font-size: 11px;
        background: #f6f3ea;
        color: #5b4a2a;
      }

      .meta-chip {
        font-size: 11px;
        padding: 4px 9px;
        border-radius: 999px;
        background: #fff9e6;
        border: 1px solid #f2e0a5;
        color: #8a6b1f;
      }

      #painel {
        display: none;
      }

      #loginCard {
        max-width: 420px;
      }
    </style>
  </head>

  <body>
    <div class="layout">
      <header>
        <img src="001 LOGO_Prancheta 1 cópia 27.png" />
        <div>
          <div class="marca">IMAGEM MODAS</div>
          <div class="sub">Dashboard de vendas</div>
        </div>
      </header>

      <div id="statusContainer" class="status-bar">
        <span class="status-dot"></span>
        <span id="statusText">Faça login para começar o dia.</span>
      </div>

      <!-- LOGIN -->
      <div id="loginCard" class="card">
        <div class="card-title">Login da vendedora</div>
        <div class="field">
          <label>Nome</label>
          <input id="nome" value="Allane" />
        </div>
        <div class="field">
          <label>Senha</label>
          <input id="senha" type="password" value="allane2025" />
        </div>
        <button class="btn-primary" onclick="login()">Entrar</button>
      </div>

      <!-- PAINEL -->
      <div id="painel" class="grid">
        <!-- ESQUERDA -->
        <div class="card">
          <div class="card-title" id="bemVindaTitulo">Bom dia</div>
          <div class="small" id="infoHoje"></div>

          <label>Meta de hoje</label>
          <div class="row">
            <div class="field">
              <input id="metaValor" type="number" min="0" step="0.01" />
            </div>
            <button class="btn-outline" onclick="salvarMetaHoje()">Salvar</button>
          </div>
          <div class="small">Meta atual: <span id="metaAtual">—</span></div>

          <hr />

          <label>Atendimentos</label>
          <div class="row">
            <div class="field">
              <input id="atendimentosQtd" type="number" min="0" />
            </div>
            <button class="btn-outline" onclick="salvarAtendimentosHoje()">
              Salvar
            </button>
          </div>
        </div>

        <!-- DIREITA -->
        <div class="card">

          <div class="tabs">
            <div class="tab active" id="tabVendas" onclick="abrirAba('vendas')">
              Vendas
            </div>
            <div class="tab" id="tabCondicionais" onclick="abrirAba('cond')">
              Condicionais
            </div>
          </div>

          <div id="abaVendas">
            <div class="card-subtitle">Lance suas vendas de hoje:</div>

            <div class="row">
              <div class="field">
                <label>Valor</label>
                <input id="valorVenda" type="number" step="0.01" />
              </div>

              <div class="field">
                <label>Pagamento</label>
                <select id="formaPagamento">
                  <option value="">Selecione</option>

                  <optgroup label="À vista">
                    <option value="dinheiro">Dinheiro</option>
                    <option value="pix">PIX</option>
                    <option value="debito">Débito</option>
                  </optgroup>

                  <optgroup label="Crédito">
                    <option value="credito_1x">Crédito 1x</option>
                    <option value="credito_2x">Crédito 2x</option>
                    <option value="credito_3x">Crédito 3x</option>
                    <option value="credito_4x">Crédito 4x</option>
                    <option value="credito_5x">Crédito 5x</option>
                    <option value="credito_6x">Crédito 6x</option>
                    <option value="credito_7x">Crédito 7x</option>
                    <option value="credito_8x">Crédito 8x</option>
                    <option value="credito_9x">Crédito 9x</option>
                    <option value="credito_10x">Crédito 10x</option>
                  </optgroup>

                  <optgroup label="Crediário">
                    <option value="crediario_1x">Crediário 1x</option>
                    <option value="crediario_2x">Crediário 2x</option>
                    <option value="crediario_3x">Crediário 3x</option>
                    <option value="crediario_4x">Crediário 4x</option>
                    <option value="crediario_5x">Crediário 5x</option>
                    <option value="crediario_6x">Crediário 6x</option>
                  </optgroup>

                  <optgroup label="Boleto">
                    <option value="boleto_1x">Boleto 1x</option>
                    <option value="boleto_2x">Boleto 2x</option>
                    <option value="boleto_3x">Boleto 3x</option>
                    <option value="boleto_4x">Boleto 4x</option>
                    <option value="boleto_5x">Boleto 5x</option>
                    <option value="boleto_6x">Boleto 6x</option>
                    <option value="boleto_7x">Boleto 7x</option>
                    <option value="boleto_8x">Boleto 8x</option>
                  </optgroup>

                  <optgroup label="Cheque pré">
                    <option value="cheque_1x">Cheque pré 1x</option>
                    <option value="cheque_2x">Cheque pré 2x</option>
                    <option value="cheque_3x">Cheque pré 3x</option>
                    <option value="cheque_4x">Cheque pré 4x</option>
                    <option value="cheque_5x">Cheque pré 5x</option>
                    <option value="cheque_6x">Cheque pré 6x</option>
                  </optgroup>
                </select>
              </div>
            </div>

            <div class="field">
              <label>Cliente</label>
              <input id="clienteNome" placeholder="Opcional" />
            </div>

            <div class="field">
              <label>Observação</label>
              <textarea id="obsVenda"></textarea>
            </div>

            <button class="btn-primary" onclick="lançarVenda()">
              Lançar venda
            </button>

            <br /><br />
            <div class="small" id="resumoVendasHoje">Nenhuma venda.</div>
            <div class="small" id="ticketMedioLinha">Ticket médio: R$ 0,00</div>
            <div class="small" id="taxaConversaoLinha">
              Taxa de conversão: 0%
            </div>

            <table>
              <thead>
                <tr>
                  <th>Hora</th>
                  <th>Cliente</th>
                  <th>Forma</th>
                  <th>Valor</th>
                </tr>
              </thead>
              <tbody id="tabelaVendas"></tbody>
            </table>
          </div>

          <!-- COND -->
          <div id="abaCond" style="display:none;">
            <div class="card-subtitle">
              Controle de condicionais em aberto.
            </div>

            <div class="row">
              <div class="field">
                <label>Peças</label>
                <input id="qtdPecas" type="number"/>
              </div>
              <div class="field">
                <label>Valor</label>
                <input id="valorCondicional" type="number" step="0.01"/>
              </div>
            </div>

            <div class="field">
              <label>Cliente</label>
              <input id="clienteCondicional"/>
            </div>

            <div class="field">
              <label>Observação</label>
              <textarea id="obsCondicional"></textarea>
            </div>

            <button class="btn-primary" onclick="lançarCondicional()">
              Lançar condicional
            </button>

            <br /><br />

            <table>
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Cliente</th>
                  <th>Peças</th>
                  <th>Valor</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="tabelaCondicionais"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API = "https://dashboard-vendas1.onrender.com/api";
      let token = null;
      let nomeVendedora = null;

      let vendasHojeQtd = 0;
      let vendasHojeTotal = 0;
      let atendimentosHojeQtd = 0;

      function hojeISO() {
        return new Date().toISOString().slice(0, 10);
      }

      function setStatus(msg, tipo) {
        const bar = document.getElementById("statusContainer");
        const text = document.getElementById("statusText");
        text.textContent = msg;
        bar.classList.remove("erro", "sucesso");
        if (tipo === "erro") bar.classList.add("erro");
        if (tipo === "sucesso") bar.classList.add("sucesso");
      }

      function abrirAba(x) {
        document.getElementById("abaVendas").style.display = x === "vendas" ? "block" : "none";
        document.getElementById("abaCond").style.display = x === "cond" ? "block" : "none";
        document.getElementById("tabVendas").classList.toggle("active", x === "vendas");
        document.getElementById("tabCondicionais").classList.toggle("active", x === "cond");
      }

      async function login() {
        const nome = document.getElementById("nome").value;
        const senha = document.getElementById("senha").value;

        try {
          const r = await fetch(API + "/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nome, senha }),
          });

          if (!r.ok) return setStatus("Falha no login.", "erro");

          const data = await r.json();
          token = data.token;
          nomeVendedora = data.vendedora.nome;

          document.getElementById("loginCard").style.display = "none";
          document.getElementById("painel").style.display = "grid";
          setStatus("Logada como " + nomeVendedora, "sucesso");

          const hoje = new Date().toLocaleDateString("pt-BR", {
            weekday: "long",
            day: "2-digit",
            month: "long",
            year: "numeric",
          });
          document.getElementById("bemVindaTitulo").textContent =
            "Bom dia, " + nomeVendedora;
          document.getElementById("infoHoje").textContent = hoje;

          await carregarMetaHoje();
          await carregarAtendimentosHoje();
          await carregarVendasHoje();
          await carregarCondicionais();
        } catch (e) {
          console.log(e);
          setStatus("Erro ao conectar.", "erro");
        }
      }

      function authHeaders() {
        return { "Content-Type": "application/json", Authorization: "Bearer " + token };
      }

      // META
      async function carregarMetaHoje() {
        const d = hojeISO();
        const r = await fetch(API + "/metas/" + d, { headers: authHeaders() });
        const j = await r.json();
        const v = Number(j.valor_meta || 0);
        document.getElementById("metaAtual").textContent = "R$ " + v.toFixed(2);
        document.getElementById("metaValor").value = v;
      }

      async function salvarMetaHoje() {
        const v = Number(document.getElementById("metaValor").value);
        const d = hojeISO();
        await fetch(API + "/metas", {
          method: "POST",
          headers: authHeaders(),
          body: JSON.stringify({ valorMeta: v, data: d }),
        });
        setStatus("Meta atualizada!", "sucesso");
        carregarMetaHoje();
      }

      // ATENDIMENTOS
      async function carregarAtendimentosHoje() {
        const d = hojeISO();
        const r = await fetch(API + "/atendimentos/" + d, {
          headers: authHeaders(),
        });
        const j = await r.json();
        atendimentosHojeQtd = Number(j.quantidade || 0);
        document.getElementById("atendimentosQtd").value = atendimentosHojeQtd;
        atualizarIndicadores();
      }

      async function salvarAtendimentosHoje() {
        const d = hojeISO();
        const qtd = Number(document.getElementById("atendimentosQtd").value);
        await fetch(API + "/atendimentos", {
          method: "POST",
          headers: authHeaders(),
          body: JSON.stringify({ quantidade: qtd, data: d }),
        });
        atendimentosHojeQtd = qtd;
        setStatus("Atendimentos atualizados!", "sucesso");
        atualizarIndicadores();
      }

      // VENDAS
      async function carregarVendasHoje() {
        const h = hojeISO();
        const r = await fetch(
          API + `/vendas?dataInicio=${h}&dataFim=${h}`,
          { headers: authHeaders() }
        );
        const vendas = await r.json();

        const tb = document.getElementById("tabelaVendas");
        tb.innerHTML = "";
        vendasHojeQtd = vendas.length;
        vendasHojeTotal = vendas.reduce((s, v) => s + Number(v.valor || 0), 0);

        vendas.forEach((v) => {
          const tr = document.createElement("tr");
          const hora = new Date(v.data_venda).toLocaleTimeString("pt-BR", {
            hour: "2-digit",
            minute: "2-digit",
          });

          tr.innerHTML = `
            <td>${hora}</td>
            <td>${v.cliente_nome || ""}</td>
            <td>${v.forma_pagamento}</td>
            <td>R$ ${Number(v.valor).toFixed(2)}</td>
          `;
          tb.appendChild(tr);
        });

        document.getElementById("resumoVendasHoje").textContent =
          vendasHojeQtd + " venda(s)";

        atualizarIndicadores();
      }

      async function lançarVenda() {
        const valor = Number(document.getElementById("valorVenda").value);
        const forma = document.getElementById("formaPagamento").value;
        const cliente = document.getElementById("clienteNome").value;
        const obs = document.getElementById("obsVenda").value;

        const r = await fetch(API + "/vendas", {
          method: "POST",
          headers: authHeaders(),
          body: JSON.stringify({
            valor,
            formaPagamento: forma,
            clienteNome: cliente,
            observacao: obs,
          }),
        });

        if (!r.ok) return setStatus("Erro ao lançar venda", "erro");

        setStatus("Venda lançada!", "sucesso");
        document.getElementById("valorVenda").value = "";
        document.getElementById("clienteNome").value = "";
        document.getElementById("obsVenda").value = "";
        carregarVendasHoje();
      }

      // CONDICIONAIS
      async function carregarCondicionais() {
        const r = await fetch(API + "/condicionais", {
          headers: authHeaders(),
        });
        const lista = await r.json();

        const tb = document.getElementById("tabelaCondicionais");
        tb.innerHTML = "";

        lista.forEach((c) => {
          const tr = document.createElement("tr");
          const data = new Date(c.data_registro).toLocaleDateString("pt-BR");
          tr.innerHTML = `
            <td>${data}</td>
            <td>${c.cliente_nome}</td>
            <td>${c.quantidade_pecas}</td>
            <td>R$ ${Number(c.valor_total).toFixed(2)}</td>
            <td><button class="btn-danger" onclick="deletarCondicional(${c.id})">X</button></td>
          `;
          tb.appendChild(tr);
        });
      }

      async function lançarCondicional() {
        const qtd = Number(document.getElementById("qtdPecas").value);
        const valor = Number(document.getElementById("valorCondicional").value);
        const cliente = document.getElementById("clienteCondicional").value;
        const obs = document.getElementById("obsCondicional").value;

        await fetch(API + "/condicionais", {
          method: "POST",
          headers: authHeaders(),
          body: JSON.stringify({
            quantidadePecas: qtd,
            valorTotal: valor,
            clienteNome: cliente,
            observacao: obs,
          }),
        });

        setStatus("Condicional lançado!", "sucesso");
        carregarCondicionais();
      }

      async function deletarCondicional(id) {
        await fetch(API + "/condicionais/" + id, {
          method: "DELETE",
          headers: authHeaders(),
        });
        setStatus("Condicional removido", "sucesso");
        carregarCondicionais();
      }

      function atualizarIndicadores() {
        const ticket = vendasHojeQtd ? vendasHojeTotal / vendasHojeQtd : 0;
        document.getElementById("ticketMedioLinha").textContent =
          "Ticket médio: R$ " + ticket.toFixed(2);

        const taxa =
          atendimentosHojeQtd > 0
            ? ((vendasHojeQtd / atendimentosHojeQtd) * 100).toFixed(1)
            : 0;
        document.getElementById("taxaConversaoLinha").textContent =
          "Taxa de conversão: " + taxa + "%";
      }
    </script>
  </body>
</html>
