<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard de Vendas - Imagem Modas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      :root {
        --verde: #5b6240;
        --bege: #f4f1ea;
        --dourado: #c7a15a;
        --texto: #333333;
        --bordas: #e0ddd5;
        --erro: #b3261e;
        --sucesso: #1b873f;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(
            circle at top,
            #ffffff 0,
            #ece7dd 45%,
            #d9d2c4 100%
          );
        color: var(--texto);
      }

      .layout {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px 16px 40px;
      }

      header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 24px;
      }

      header img {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid rgba(0, 0, 0, 0.08);
      }

      header .marca {
        font-size: 14px;
        letter-spacing: 0.26em;
        text-transform: uppercase;
        color: #555;
      }

      header .sub {
        font-size: 12px;
        letter-spacing: 0.25em;
        text-transform: uppercase;
        color: #888;
        margin-top: 2px;
      }

      .status-bar {
        margin-bottom: 16px;
        font-size: 13px;
        padding: 10px 12px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.75);
        border: 1px solid rgba(0, 0, 0, 0.06);
        backdrop-filter: blur(8px);
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--verde);
      }
    </style>
  </head>

  <body>
    <div class="layout">
      <header>
        <img src="001 LOGO_Prancheta 1 cópia 27.jpeg" alt="Logo Imagem Modas" />
        <div>
          <div class="marca">IMAGEM MODAS</div>
          <div class="sub">Dashboard de vendas</div>
        </div>
      </header>

      <div id="statusContainer" class="status-bar">
        <span class="status-dot"></span>
        <span id="statusText">Faça login para começar o dia.</span>
      </div>
      <!-- LOGIN -->
      <div id="loginCard" class="card">
        <div class="card-title">Login</div>
        <div class="card-subtitle">
          Acesso exclusivo — Imagem Modas
        </div>

        <div class="field">
          <label for="nome">Usuário</label>
          <input id="nome" autocomplete="username" placeholder="Ex: Allane" />
        </div>

        <div class="field">
          <label for="senha">Senha</label>
          <input
            id="senha"
            type="password"
            autocomplete="current-password"
            placeholder="Digite sua senha"
          />
        </div>

        <button class="btn-primary" onclick="login()">Entrar</button>
      </div>

      <!-- PAINEL PADRÃO (VENDEDORA OU GERENTE) -->
      <div id="painel" style="display:none;">
        <div id="painelConteudo"></div>
      </div>
    </div>

    <script>
      const API = "https://dashboard-vendas1.onrender.com/api";
      let token = null;
      let usuario = null;

      function setStatus(msg, tipo) {
        const bar = document.getElementById("statusContainer");
        const text = document.getElementById("statusText");
        text.textContent = msg;

        bar.classList.remove("erro", "sucesso");
        if (tipo === "erro") bar.classList.add("erro");
        if (tipo === "sucesso") bar.classList.add("sucesso");
      }

      async function login() {
        const nome = document.getElementById("nome").value.trim();
        const senha = document.getElementById("senha").value.trim();

        if (!nome || !senha) {
          setStatus("Preencha login e senha.", "erro");
          return;
        }

        setStatus("Conectando...", null);

        try {
          const resp = await fetch(API + "/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nome, senha })
          });

          if (!resp.ok) {
            setStatus("Usuário ou senha incorretos.", "erro");
            return;
          }

          const data = await resp.json();
          token = data.token;
          usuario = data.vendedora;

          document.getElementById("loginCard").style.display = "none";
          document.getElementById("painel").style.display = "block";

          if (usuario.is_gerente) {
            setStatus("Logada como GERENTE.", "sucesso");
            carregarPainelGerente();
          } else {
            setStatus(`Logada como ${usuario.nome}.`, "sucesso");
            carregarPainelVendedora();
          }
        } catch (e) {
          console.error(e);
          setStatus("Erro ao conectar ao servidor.", "erro");
        }
      }

      function authHeaders() {
        return {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        };
      }

      /* ================================
            PAINEL DA GERENTE
         ================================ */
      function carregarPainelGerente() {
        document.getElementById("painelConteudo").innerHTML = `
          <div class="card">
            <div class="card-title">Painel da Gerente</div>
            <div class="card-subtitle">
              Visão geral da equipe, metas, vendas e condicionais.
            </div>

            <button class="btn-outline" onclick="carregarResumoEquipe()">
              Carregar visão geral
            </button>

            <div id="painelGerenteResultado" style="margin-top:20px;"></div>
          </div>
        `;
      }

      async function carregarResumoEquipe() {
        try {
          const resp = await fetch(API + "/gerente/resumo", {
            headers: authHeaders()
          });

          if (!resp.ok) {
            document.getElementById("painelGerenteResultado").innerHTML =
              "<p>Erro ao carregar dados.</p>";
            return;
          }

          const dados = await resp.json();

          document.getElementById("painelGerenteResultado").innerHTML = `
            <h3>Resumo geral do dia</h3>
            <p><strong>Total em vendas:</strong> R$ ${dados.totalVendas.toFixed(2)}</p>
            <p><strong>Total de atendimentos:</strong> ${dados.totalAtendimentos}</p>
            <p><strong>Ticket médio geral:</strong> R$ ${dados.ticketMedio.toFixed(2)}</p>
            <p><strong>Taxa de conversão geral:</strong> ${dados.taxaConversao.toFixed(1)}%</p>
          `;
        } catch (e) {
          console.error(e);
        }
      }

      /* ================================
            PAINEL DA VENDEDORA
         ================================ */
      function carregarPainelVendedora() {
        document.getElementById("painelConteudo").innerHTML = `
          <div class="card">
            <div class="card-title">Bem-vinda, ${usuario.nome}</div>
            <div class="card-subtitle">Aqui estão suas metas e vendas de hoje.</div>

            <button class="btn-outline" onclick="carregarDashboardVendedora()">
              Carregar painel
            </button>

            <div id="painelVendedoraResultado" style="margin-top:20px;"></div>
          </div>
        `;
      }

      async function carregarDashboardVendedora() {
        const hoje = new Date().toISOString().slice(0, 10);

        try {
          const resp = await fetch(API + "/vendas?dataInicio=" + hoje + "&dataFim=" + hoje, {
            headers: authHeaders()
          });

          const vendas = await resp.json();
          const total = vendas.reduce((s, v) => s + Number(v.valor), 0);

          document.getElementById("painelVendedoraResultado").innerHTML = `
            <h3>Seu dia hoje</h3>
            <p><strong>Total vendido:</strong> R$ ${total.toFixed(2)}</p>
            <p><strong>Número de vendas:</strong> ${vendas.length}</p>
          `;
        } catch (e) {
          console.error(e);
        }
      }
    </script>
  </body>
</html>
/* ==========================================================
          PAINEL VENDEDORA – COMPLETO
   ========================================================== */

async function carregarPainelVendedora() {
  document.getElementById("painelConteudo").innerHTML = `
    <div class="card">
      <div class="card-title">Bem-vinda, ${usuario.nome}</div>
      <div class="card-subtitle">
        Acompanhe suas metas, vendas, atendimentos e condicionais de hoje.
      </div>

      <div id="painelVendedoraContent"></div>
    </div>
  `;

  await montarPainelVendedora();
}

async function montarPainelVendedora() {
  const hoje = hojeISO();

  // Buscar tudo simultaneamente
  const [metaDinamicaR, atendR, vendasR, condR] = await Promise.all([
    fetch(API + "/meta-hoje-dinamica", { headers: authHeaders() }).then(r => r.json()),
    fetch(API + "/atendimentos/" + hoje, { headers: authHeaders() }).then(r => r.json()),
    fetch(API + `/vendas?dataInicio=${hoje}&dataFim=${hoje}`, { headers: authHeaders() }).then(r => r.json()),
    fetch(API + "/condicionais", { headers: authHeaders() }).then(r => r.json())
  ]);

  const metaHoje = Number(metaDinamicaR.metaDinamica || 0);
  const atendimentos = Number(atendR.quantidade || 0);
  const vendas = vendasR || [];
  const condicionais = condR || [];

  const totalVendas = vendas.reduce((s, v) => s + Number(v.valor), 0);
  const ticketMedio = vendas.length ? totalVendas / vendas.length : 0;
  const taxaConversao = atendimentos ? (vendas.length / atendimentos) * 100 : 0;

  // Montar layout
  const container = document.getElementById("painelVendedoraContent");

  container.innerHTML = `
    <!-- METAS -->
    <div class="card" style="margin-top:20px;">
      <div class="card-title">Meta de hoje</div>
      <div class="card-subtitle small">Meta dinâmica baseada na meta mensal.</div>

      <p><strong>Meta de hoje:</strong> R$ ${metaHoje.toFixed(2)}</p>
      <p><strong>Total vendido:</strong> R$ ${totalVendas.toFixed(2)}</p>
      <p><strong>Falta:</strong> R$ ${(metaHoje - totalVendas).toFixed(2)}</p>
    </div>

    <!-- ATENDIMENTOS -->
    <div class="card" style="margin-top:20px;">
      <div class="card-title">Atendimentos</div>
      <div class="row">
        <div class="field">
          <label>Atendimentos do dia</label>
          <input type="number" id="atendimentosInput" value="${atendimentos}" />
        </div>
        <button class="btn-primary" onclick="salvarAtendimentosVendedora()">Salvar</button>
      </div>

      <p class="small">
        Conversão: ${taxaConversao.toFixed(1)}%<br>
        Ticket médio: R$ ${ticketMedio.toFixed(2)}
      </p>
    </div>

    <!-- LANÇAR VENDA -->
    <div class="card" style="margin-top:20px;">
      <div class="card-title">Lançar venda</div>
      <div class="row">
        <div class="field">
          <label>Valor (R$)</label>
          <input id="valorVenda" type="number" step="0.01" />
        </div>
        <div class="field">
          <label>Forma</label>
          <select id="formaPagamento">
            <option value="">Selecione</option>

            <optgroup label="À vista">
              <option value="dinheiro">Dinheiro</option>
              <option value="pix">PIX</option>
              <option value="debito">Débito</option>
            </optgroup>

            <optgroup label="Crédito">
              ${Array.from({length:10}, (_,i)=>`<option value="credito_${i+1}x">Crédito ${i+1}x</option>`).join("")}
            </optgroup>

            <optgroup label="Crediário">
              ${Array.from({length:6}, (_,i)=>`<option value="crediario_${i+1}x">Crediário ${i+1}x</option>`).join("")}
            </optgroup>

            <optgroup label="Boleto">
              ${Array.from({length:8}, (_,i)=>`<option value="boleto_${i+1}x">Boleto ${i+1}x</option>`).join("")}
            </optgroup>

            <optgroup label="Cheque pré">
              ${Array.from({length:6}, (_,i)=>`<option value="cheque_${i+1}x">Cheque pré ${i+1}x</option>`).join("")}
            </optgroup>
          </select>
        </div>
      </div>

      <div class="field">
        <label>Cliente</label>
        <input id="clienteVenda" placeholder="Nome da cliente (opcional)" />
      </div>

      <div class="field">
        <label>Observação</label>
        <textarea id="obsVenda"></textarea>
      </div>

      <button class="btn-primary" onclick="lançarVendaVendedora()">Lançar venda</button>
    </div>

    <!-- LISTA DE VENDAS -->
    <div class="card" style="margin-top:20px;">
      <div class="card-title">Vendas de hoje</div>

      <table style="margin-top:10px;">
        <thead>
          <tr>
            <th>Hora</th>
            <th>Cliente</th>
            <th>Forma</th>
            <th>Valor</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="listaVendas">
          ${vendas.map(v => `
            <tr>
              <td>${new Date(v.data_venda).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}</td>
              <td>${v.cliente_nome || "-"}</td>
              <td>${v.forma_pagamento}</td>
              <td>R$ ${Number(v.valor).toFixed(2)}</td>
              <td><button class="btn-danger" onclick="apagarVenda(${v.id})">X</button></td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>

    <!-- LANÇAR CONDICIONAL -->
    <div class="card" style="margin-top:20px;">
      <div class="card-title">Lançar condicional</div>

      <div class="row">
        <div class="field">
          <label>Qtd Peças</label>
          <input id="qtdPecas" type="number" />
        </div>
        <div class="field">
          <label>Valor Total</label>
          <input id="valorCond" type="number" step="0.01" />
        </div>
      </div>

      <div class="field">
        <label>Cliente</label>
        <input id="clienteCond" />
      </div>

      <div class="field">
        <label>Observação</label>
        <textarea id="obsCond"></textarea>
      </div>

      <button class="btn-primary" onclick="lançarCondicionalVendedora()">Lançar</button>
    </div>

    <!-- LISTA DE CONDICIONAIS -->
    <div class="card" style="margin-top:20px;">
      <div class="card-title">Condicionais em aberto</div>

      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Cliente</th>
            <th>Peças</th>
            <th>Valor</th>
          </tr>
        </thead>
        <tbody>
          ${condicionais.map(c => `
            <tr>
              <td>${new Date(c.data_registro).toLocaleDateString("pt-BR")}</td>
              <td>${c.cliente_nome}</td>
              <td>${c.quantidade_pecas}</td>
              <td>R$ ${Number(c.valor_total).toFixed(2)}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `;
}

/* ==========================================================
          FUNÇÕES DA VENDEDORA
   ========================================================== */

async function salvarAtendimentosVendedora() {
  const quantidade = Number(document.getElementById("atendimentosInput").value);
  const data = hojeISO();

  await fetch(API + "/atendimentos", {
    method: "POST",
    headers: authHeaders(),
    body: JSON.stringify({ quantidade, data })
  });

  carregarPainelVendedora();
}

async function lançarVendaVendedora() {
  const valor = Number(document.getElementById("valorVenda").value);
  const formaPagamento = document.getElementById("formaPagamento").value;
  const clienteNome = document.getElementById("clienteVenda").value.trim();
  const observacao = document.getElementById("obsVenda").value.trim();

  if (!valor || !formaPagamento) return setStatus("Preencha os campos obrigatórios.", "erro");

  await fetch(API + "/vendas", {
    method: "POST",
    headers: authHeaders(),
    body: JSON.stringify({ valor, formaPagamento, clienteNome, observacao })
  });

  carregarPainelVendedora();
}

async function apagarVenda(id) {
  await fetch(API + "/vendas/" + id, {
    method: "DELETE",
    headers: authHeaders()
  });

  carregarPainelVendedora();
}

async function lançarCondicionalVendedora() {
  const quantidadePecas = Number(document.getElementById("qtdPecas").value);
  const valorTotal = Number(document.getElementById("valorCond").value);
  const clienteNome = document.getElementById("clienteCond").value.trim();
  const observacao = document.getElementById("obsCond").value.trim();

  if (!quantidadePecas || !clienteNome) return setStatus("Campos obrigatórios faltando.", "erro");

  await fetch(API + "/condicionais", {
    method: "POST",
    headers: authHeaders(),
    body: JSON.stringify({ quantidadePecas, valorTotal, clienteNome, observacao })
  });

  carregarPainelVendedora();
}
/* ==========================================================
      PAINEL DA GERENTE – COMPLETO
   ========================================================== */

async function carregarPainelGerente() {
  document.getElementById("painelConteudo").innerHTML = `
    <div class="card">
      <div class="card-title">Painel da Gerente</div>
      <div class="card-subtitle">
        Visão geral de todas as vendedoras • Indicadores completos
      </div>

      <div id="painelGerenteContent"></div>
    </div>
  `;

  await montarPainelGerente();
}

async function montarPainelGerente() {
  const hoje = hojeISO();

  // Carregar tudo ao mesmo tempo
  const [
    metasR,
    atendR,
    vendasR,
    condR,
    vendedorasR
  ] = await Promise.all([
    fetch(API + "/meta-hoje-dinamica", { headers: authHeaders() }).then(r => r.json()),
    fetch(API + "/atendimentos-geral/" + hoje, { headers: authHeaders() }).then(r => r.json()),
    fetch(API + `/vendas-geral?dataInicio=${hoje}&dataFim=${hoje}`, { headers: authHeaders() }).then(r => r.json()),
    fetch(API + "/condicionais", { headers: authHeaders() }).then(r => r.json()),
    fetch(API + "/vendedoras", { headers: authHeaders() }).then(r => r.json())
  ]);

  const metaHoje = Number(metasR.metaDinamica || 0);
  const atendimentos = Number(atendR.total || 0);
  const vendas = vendasR || [];
  const condicionais = condR || [];
  const vendedoras = vendedorasR || [];

  const totalVendas = vendas.reduce((s, v) => s + Number(v.valor), 0);

  const ticketMedioGlobal = vendas.length ? totalVendas / vendas.length : 0;
  const taxaConversaoGlobal = atendimentos ? (vendas.length / atendimentos) * 100 : 0;

  document.getElementById("painelGerenteContent").innerHTML = `
    <!-- META MENSAL -->
    <div class="card" style="margin-top:20px;">
      <div class="card-title">Meta mensal</div>
      <div class="card-subtitle small">
        A gerente define a meta mensal. O sistema divide entre dias úteis automaticamente.
      </div>

      <p><strong>Meta dinâmica de hoje:</strong> R$ ${metaHoje.toFixed(2)}</p>

      <div class="row">
        <div class="field">
          <label>Nova meta mensal (R$)</label>
          <input id="metaMensalInput" type="number" />
        </div>
        <button class="btn-primary" onclick="salvarMetaMensal()">Salvar</button>
      </div>
    </div>

    <!-- CADASTRO DE VENDEDORA -->
    <div class="card" style="margin-top:20px;">
      <div class="card-title">Cadastrar nova vendedora</div>

      <div class="row">
        <div class="field">
          <label>Nome</label>
          <input id="novaVendNome" />
        </div>

        <div class="field">
          <label>Senha inicial</label>
          <input id="novaVendSenha" type="password" />
        </div>
      </div>

      <button class="btn-primary" onclick="cadastrarVendedora()">Cadastrar</button>
    </div>

    <!-- INDICADORES GERAIS -->
    <div class="card" style="margin-top:20px;">
      <div class="card-title">Indicadores gerais do dia</div>

      <p><strong>Total vendido:</strong> R$ ${totalVendas.toFixed(2)}</p>
      <p><strong>Atendimentos:</strong> ${atendimentos}</p>
      <p><strong>Ticket médio geral:</strong> R$ ${ticketMedioGlobal.toFixed(2)}</p>
      <p><strong>Taxa de conversão:</strong> ${taxaConversaoGlobal.toFixed(1)}%</p>
    </div>

    <!-- RANKING -->
    <div class="card" style="margin-top:20px;">
      <div class="card-title">Ranking do dia</div>
      ${montarRankingHTML(vendas, vendedoras)}
    </div>

    <!-- VENDAS GERAIS -->
    <div class="card" style="margin-top:20px;">
      <div class="card-title">Vendas de hoje (todas)</div>

      <table style="margin-top:10px;">
        <thead>
          <tr>
            <th>Vendedora</th>
            <th>Hora</th>
            <th>Cliente</th>
            <th>Forma</th>
            <th>Valor</th>
          </tr>
        </thead>
        <tbody>
          ${vendas.map(v => `
            <tr>
              <td>${v.vendedora_nome}</td>
              <td>${new Date(v.data_venda).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}</td>
              <td>${v.cliente_nome || "-"}</td>
              <td>${v.forma_pagamento}</td>
              <td>R$ ${Number(v.valor).toFixed(2)}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>

    <!-- CONDICIONAIS -->
    <div class="card" style="margin-top:20px;">
      <div class="card-title">Condicionais em aberto</div>

      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Cliente</th>
            <th>Peças</th>
            <th>Valor</th>
            <th>Vendedora</th>
          </tr>
        </thead>
        <tbody>
          ${condicionais.map(c => `
            <tr>
              <td>${new Date(c.data_registro).toLocaleDateString("pt-BR")}</td>
              <td>${c.cliente_nome}</td>
              <td>${c.quantidade_pecas}</td>
              <td>R$ ${Number(c.valor_total).toFixed(2)}</td>
              <td>${c.vendedora_nome}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `;
}

/* ==========================================================
      FUNÇÕES EXTRAS DA GERENTE
   ========================================================== */

function montarRankingHTML(vendas, vendedoras) {
  const somaPorVend = {};

  vendas.forEach(v => {
    if (!somaPorVend[v.vendedora_nome]) somaPorVend[v.vendedora_nome] = 0;
    somaPorVend[v.vendedora_nome] += Number(v.valor);
  });

  const ranking = Object.entries(somaPorVend).sort((a, b) => b[1] - a[1]);

  if (!ranking.length) return "<p class='small'>Nenhuma venda hoje.</p>";

  return `
    <ol>
      ${ranking.map(r => `
        <li><strong>${r[0]}</strong> — R$ ${r[1].toFixed(2)}</li>
      `).join("")}
    </ol>
  `;
}

async function salvarMetaMensal() {
  const valor = Number(document.getElementById("metaMensalInput").value);
  if (!valor) return alert("Informe a meta mensal!");

  await fetch(API + "/meta-mensal", {
    method: "POST",
    headers: authHeaders(),
    body: JSON.stringify({ metaMensal: valor })
  });

  alert("Meta mensal atualizada!");
  carregarPainelGerente();
}

async function cadastrarVendedora() {
  const nome = document.getElementById("novaVendNome").value.trim();
  const senha = document.getElementById("novaVendSenha").value.trim();

  if (!nome || !senha) {
    alert("Preencha nome e senha.");
    return;
  }

  const resp = await fetch(API + "/vendedoras", {
    method: "POST",
    headers: authHeaders(),
    body: JSON.stringify({ nome, senha })
  });

  if (!resp.ok) {
    alert("Erro ao cadastrar. Talvez nome já exista.");
    return;
  }

  alert("Vendedora cadastrada!");
  document.getElementById("novaVendNome").value = "";
  document.getElementById("novaVendSenha").value = "";

  carregarPainelGerente();
}
