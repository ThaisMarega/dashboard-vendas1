<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard de Vendas - Imagem Modas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      :root {
        --verde: #5b6240;
        --bege: #f4f1ea;
        --dourado: #c7a15a;
        --texto: #333333;
        --bordas: #e0ddd5;
        --erro: #b3261e;
        --sucesso: #1b873f;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(
            circle at top,
            #ffffff 0,
            #ece7dd 45%,
            #d9d2c4 100%
          );
        color: var(--texto);
      }

      .layout {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px 16px 40px;
      }

      header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 24px;
      }

      header img {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid rgba(0, 0, 0, 0.08);
      }

      header .marca {
        font-size: 14px;
        letter-spacing: 0.26em;
        text-transform: uppercase;
        color: #555;
      }

      header .sub {
        font-size: 12px;
        letter-spacing: 0.25em;
        text-transform: uppercase;
        color: #888;
        margin-top: 2px;
      }

      .status-bar {
        margin-bottom: 16px;
        font-size: 13px;
        padding: 10px 12px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.75);
        border: 1px solid rgba(0, 0, 0, 0.06);
        backdrop-filter: blur(8px);
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--verde);
      }

      .status-bar.erro {
        color: var(--erro);
        border-color: #f4c7c3;
        background: #fff5f5;
      }

      .status-bar.erro .status-dot {
        background: var(--erro);
      }

      .status-bar.sucesso {
        color: var(--sucesso);
      }

      .status-bar.sucesso .status-dot {
        background: var(--sucesso);
      }

      .grid {
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.4fr);
        gap: 20px;
      }

      @media (max-width: 900px) {
        .grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .card {
        background: rgba(255, 255, 255, 0.92);
        border-radius: 18px;
        padding: 18px 18px 20px;
        box-shadow: 0 14px 40px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
      }

      .card-title {
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 4px;
        letter-spacing: 0.07em;
        text-transform: uppercase;
      }

      .card-subtitle {
        font-size: 12px;
        color: #777;
        margin-bottom: 14px;
      }

      label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #555;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid var(--bordas);
        font-size: 14px;
        outline: none;
        background: rgba(255, 255, 255, 0.9);
      }

      input:focus,
      select:focus,
      textarea:focus {
        border-color: var(--verde);
        box-shadow: 0 0 0 1px rgba(91, 98, 64, 0.4);
      }

      textarea {
        resize: vertical;
        min-height: 60px;
      }

      .field {
        margin-bottom: 10px;
      }

      .row {
        display: flex;
        gap: 10px;
      }

      .row > .field {
        flex: 1;
      }

      button {
        padding: 8px 14px;
        border-radius: 999px;
        border: none;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        letter-spacing: 0.06em;
        text-transform: uppercase;
      }

      .btn-primary {
        background: var(--verde);
        color: #fff;
      }

      .btn-outline {
        background: transparent;
        border: 1px solid var(--verde);
        color: var(--verde);
      }

      .btn-danger {
        background: #faf0f0;
        color: var(--erro);
        border: 1px solid #f2c7c4;
        padding: 5px 10px;
        font-size: 11px;
      }

      .small {
        font-size: 12px;
        color: #777;
      }

      .tabs {
        display: flex;
        gap: 6px;
        margin-bottom: 12px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      }

      .tab {
        padding: 8px 12px;
        border-radius: 999px 999px 0 0;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        color: #666;
      }

      .tab.active {
        background: #ffffff;
        color: #111;
        border: 1px solid rgba(0, 0, 0, 0.06);
        border-bottom-color: #ffffff;
      }

      .tab-content {
        padding-top: 4px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      th,
      td {
        padding: 6px 4px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.04);
        text-align: left;
      }

      th {
        font-weight: 600;
        color: #666;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        padding: 3px 8px;
        border-radius: 999px;
        font-size: 11px;
        background: #f6f3ea;
        color: #5b4a2a;
      }

      .meta-chip {
        font-size: 11px;
        padding: 4px 9px;
        border-radius: 999px;
        background: #fff9e6;
        border: 1px solid #f2e0a5;
        color: #8a6b1f;
      }

      /* Login x painel */
      #painel {
        display: none;
      }

      #loginCard {
        max-width: 420px;
      }

      /* Barra de progresso da meta */
      .progress-container {
        margin-top: 8px;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        border-radius: 999px;
        background: #f0ebe0;
        overflow: hidden;
        margin-bottom: 4px;
      }

      .progress-inner {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #5b6240, #c7a15a);
        transition: width 0.3s ease;
      }

      .meta-status {
        font-size: 11px;
        color: #666;
      }

      /* Card de ger√™ncia */
      #cardGerencia {
        margin-top: 20px;
        display: none;
      }

      .tag-gerente {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 999px;
        background: #f3efe0;
        border: 1px solid #e0d8b8;
        margin-left: 6px;
        text-transform: uppercase;
        letter-spacing: 0.07em;
      }

      @media (max-width: 600px) {
        header {
          flex-direction: column;
          align-items: flex-start;
        }

        .status-bar {
          width: 100%;
        }
      }
    </style>
  </head>

  <body>
    <div class="layout">
      <header>
        <img
          src="001 LOGO_Prancheta 1 c√≥pia 27.png"
          alt="Logo Imagem Modas"
        />
        <div>
          <div class="marca">IMAGEM MODAS</div>
          <div class="sub">Dashboard de vendas</div>
        </div>
      </header>

      <div id="statusContainer" class="status-bar">
        <span class="status-dot"></span>
        <span id="statusText">Fa√ßa login para come√ßar o dia.</span>
      </div>

      <!-- LOGIN -->
      <div id="loginCard" class="card">
        <div class="card-title">Login da vendedora</div>
        <div class="card-subtitle">
          Acesso exclusivo para vendedoras Imagem Modas.
        </div>

        <div class="field">
          <label for="nome">Nome</label>
          <input id="nome" value="Allane" autocomplete="username" />
        </div>

        <div class="field">
          <label for="senha">Senha</label>
          <input
            id="senha"
            type="password"
            value="allane2025"
            autocomplete="current-password"
          />
        </div>

        <button class="btn-primary" onclick="login()">Entrar</button>
      </div>

      <!-- PAINEL AP√ìS LOGIN -->
      <div id="painel" class="grid">
        <!-- Coluna esquerda: resumo + meta + atendimentos -->
        <div class="card">
          <div class="card-title" id="bemVindaTitulo">Bom dia</div>
          <div class="card-subtitle small" id="infoHoje"></div>

          <!-- META DI√ÅRIA -->
          <div class="field">
            <label>Meta de hoje</label>
            <div class="row">
              <div class="field">
                <input
                  id="metaValor"
                  type="number"
                  min="0"
                  step="0.01"
                  placeholder="R$ 0,00"
                />
              </div>
              <button class="btn-outline" onclick="salvarMetaHoje()">
                Salvar meta
              </button>
            </div>
            <div class="small">
              Meta atual: <span id="metaAtual" class="meta-chip">‚Äî</span>
            </div>

            <!-- Barra de progresso da meta -->
            <div class="progress-container">
              <div class="progress-bar">
                <div id="metaProgressInner" class="progress-inner"></div>
              </div>
              <div id="metaStatusLinha" class="meta-status">
                Aguardando vendas para calcular a meta.
              </div>
            </div>
          </div>

          <!-- META MENSAL -->
          <div class="field" style="margin-top: 16px">
            <label>Meta mensal</label>
            <div class="row">
              <div class="field">
                <input
                  id="metaMensalValor"
                  type="number"
                  min="0"
                  step="0.01"
                  placeholder="R$ 0,00"
                />
              </div>
              <button class="btn-outline" onclick="salvarMetaMensal()">
                Salvar meta mensal
              </button>
            </div>
            <div class="small" id="metaMensalResumo">
              Nenhuma meta mensal definida.
            </div>
            <div class="small" id="metaMensalSugestao"></div>
          </div>

          <hr style="border: none; border-top: 1px solid #eee; margin: 16px 0" />

          <div>
            <div class="card-title" style="font-size: 13px">Atendimentos</div>
            <div class="card-subtitle small">
              Quantos clientes voc√™ atendeu hoje (presencial, WhatsApp,
              Instagram, etc).
            </div>

            <div class="row">
              <div class="field">
                <label for="atendimentosQtd">Atendimentos de hoje</label>
                <input
                  id="atendimentosQtd"
                  type="number"
                  min="0"
                  step="1"
                  placeholder="0"
                />
              </div>
              <button class="btn-outline" onclick="salvarAtendimentosHoje()">
                Salvar
              </button>
            </div>
          </div>
        </div>

        <!-- Coluna direita: abas Vendas / Condicionais -->
        <div class="card">
          <div class="tabs">
            <div
              class="tab active"
              id="tabVendas"
              onclick="abrirAba('vendas')"
            >
              Vendas
            </div>
            <div
              class="tab"
              id="tabCondicionais"
              onclick="abrirAba('condicionais')"
            >
              Condicionais
            </div>
          </div>

          <div class="tab-content">
            <!-- ABA VENDAS -->
            <div id="abaVendas">
              <div class="card-subtitle">
                Lance as vendas de hoje e acompanhe ticket m√©dio, pe√ßas e
                convers√£o.
              </div>

              <div class="row">
                <div class="field">
                  <label for="valorVenda">Valor (R$)</label>
                  <input
                    id="valorVenda"
                    type="number"
                    min="0"
                    step="0.01"
                    placeholder="0,00"
                  />
                </div>

                <div class="field">
                  <label for="qtdPecasVenda">Qtd. de pe√ßas</label>
                  <input
                    id="qtdPecasVenda"
                    type="number"
                    min="1"
                    step="1"
                    placeholder="1"
                  />
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label for="formaPagamento">Forma de pagamento</label>
                  <select id="formaPagamento">
                    <option value="">Selecione</option>

                    <optgroup label="√Ä vista">
                      <option value="dinheiro">Dinheiro</option>
                      <option value="pix">PIX</option>
                      <option value="debito">D√©bito</option>
                    </optgroup>

                    <optgroup label="Cr√©dito">
                      <option value="credito_1x">Cr√©dito 1x</option>
                      <option value="credito_2x">Cr√©dito 2x</option>
                      <option value="credito_3x">Cr√©dito 3x</option>
                      <option value="credito_4x">Cr√©dito 4x</option>
                      <option value="credito_5x">Cr√©dito 5x</option>
                      <option value="credito_6x">Cr√©dito 6x</option>
                      <option value="credito_7x">Cr√©dito 7x</option>
                      <option value="credito_8x">Cr√©dito 8x</option>
                      <option value="credito_9x">Cr√©dito 9x</option>
                      <option value="credito_10x">Cr√©dito 10x</option>
                    </optgroup>

                    <optgroup label="Credi√°rio">
                      <option value="crediario_1x">Credi√°rio 1x</option>
                      <option value="crediario_2x">Credi√°rio 2x</option>
                      <option value="crediario_3x">Credi√°rio 3x</option>
                      <option value="crediario_4x">Credi√°rio 4x</option>
                      <option value="crediario_5x">Credi√°rio 5x</option>
                      <option value="crediario_6x">Credi√°rio 6x</option>
                    </optgroup>

                    <optgroup label="Boleto">
                      <option value="boleto_1x">Boleto 1x</option>
                      <option value="boleto_2x">Boleto 2x</option>
                      <option value="boleto_3x">Boleto 3x</option>
                      <option value="boleto_4x">Boleto 4x</option>
                      <option value="boleto_5x">Boleto 5x</option>
                      <option value="boleto_6x">Boleto 6x</option>
                      <option value="boleto_7x">Boleto 7x</option>
                      <option value="boleto_8x">Boleto 8x</option>
                    </optgroup>

                    <optgroup label="Cheque pr√©">
                      <option value="cheque_1x">Cheque pr√© 1x</option>
                      <option value="cheque_2x">Cheque pr√© 2x</option>
                      <option value="cheque_3x">Cheque pr√© 3x</option>
                      <option value="cheque_4x">Cheque pr√© 4x</option>
                      <option value="cheque_5x">Cheque pr√© 5x</option>
                      <option value="cheque_6x">Cheque pr√© 6x</option>
                    </optgroup>
                  </select>
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label for="clienteNome">Nome da cliente</label>
                  <input
                    id="clienteNome"
                    type="text"
                    placeholder="Opcional"
                  />
                </div>
              </div>

              <div class="field">
                <label for="obsVenda">Observa√ß√£o</label>
                <textarea
                  id="obsVenda"
                  placeholder="Ex: look completo, quem indicou, pe√ßa-chave..."
                ></textarea>
              </div>

              <button class="btn-primary" onclick="lancarVenda()">
                Lan√ßar venda
              </button>

              <div
                class="card-subtitle"
                style="margin-top: 14px; margin-bottom: 4px"
              >
                Indicadores de hoje
              </div>
              <div class="small" id="resumoVendasHoje">Nenhuma venda ainda.</div>
              <div class="small" id="ticketMedioLinha">
                Ticket m√©dio: R$ 0,00
              </div>
              <div class="small" id="taxaConversaoLinha">
                Taxa de convers√£o: 0%
              </div>
              <div class="small" id="pecasPorVendaLinha">
                Pe√ßas por venda: 0,0
              </div>
              <div class="small" id="pecasPorAtendimentoLinha">
                Pe√ßas por atendimento: 0,0
              </div>
              <div class="small" id="totaisFormaPagamento">
                Totais por forma de pagamento: ‚Äî
              </div>

              <div
                class="card-subtitle"
                style="margin-top: 12px; margin-bottom: 6px"
              >
                Vendas de hoje
              </div>

              <div style="max-height: 220px; overflow-y: auto; margin-top: 6px">
                <table id="tabelaVendas">
                  <thead>
                    <tr>
                      <th>Hor√°rio</th>
                      <th>Cliente</th>
                      <th>Forma</th>
                      <th>Pe√ßas</th>
                      <th>Valor</th>
                      <th>A√ß√µes</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <!-- ABA CONDICIONAIS -->
            <div id="abaCondicionais" style="display: none">
              <div class="card-subtitle">
                Controle das pe√ßas que saem em condicional.
              </div>

              <div class="row">
                <div class="field">
                  <label for="qtdPecas">Qtd. de pe√ßas</label>
                  <input
                    id="qtdPecas"
                    type="number"
                    min="1"
                    step="1"
                    placeholder="0"
                  />
                </div>

                <div class="field">
                  <label for="valorCondicional">Valor total (R$)</label>
                  <input
                    id="valorCondicional"
                    type="number"
                    min="0"
                    step="0.01"
                    placeholder="0,00"
                  />
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label for="clienteCondicional">Cliente</label>
                  <input
                    id="clienteCondicional"
                    type="text"
                    placeholder="Nome da cliente"
                  />
                </div>
              </div>

              <div class="field">
                <label for="obsCondicional">Observa√ß√£o</label>
                <textarea
                  id="obsCondicional"
                  placeholder="Prazo de retorno, pe√ßas principais, etc."
                ></textarea>
              </div>

              <button class="btn-primary" onclick="lancarCondicional()">
                Lan√ßar condicional
              </button>

              <div
                class="card-subtitle"
                style="margin-top: 14px; margin-bottom: 6px"
              >
                Condicionais em aberto
              </div>

              <div style="max-height: 220px; overflow-y: auto; margin-top: 6px">
                <table id="tabelaCondicionais">
                  <thead>
                    <tr>
                      <th>Data</th>
                      <th>Cliente</th>
                      <th>Pe√ßas</th>
                      <th>Valor</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- CARD DE GER√äNCIA -->
      <div id="cardGerencia" class="card">
        <div class="card-title">
          √Årea da ger√™ncia
          <span class="tag-gerente">ACESSO GERENTE</span>
        </div>
        <div class="card-subtitle">
          Aqui voc√™ cadastra novas vendedoras e v√™ a lista de acessos.
        </div>

        <div class="row">
          <div class="field">
            <label for="novaVendedoraNome">Nome da vendedora</label>
            <input
              id="novaVendedoraNome"
              type="text"
              placeholder="Ex: Carla"
            />
          </div>
          <div class="field">
            <label for="novaVendedoraSenha">Senha</label>
            <input
              id="novaVendedoraSenha"
              type="password"
              placeholder="Defina uma senha"
            />
          </div>
        </div>

        <div class="field" style="margin-bottom: 6px">
          <label>
            <input
              id="novaVendedoraGerente"
              type="checkbox"
              style="width: auto; margin-right: 6px"
            />
            Tamb√©m √© gerente
          </label>
        </div>

        <button class="btn-outline" onclick="cadastrarVendedora()">
          Cadastrar vendedora
        </button>

        <div
          class="card-subtitle"
          style="margin-top: 16px; margin-bottom: 6px"
        >
          Vendedoras cadastradas
        </div>
        <div class="small" id="listaVendedoras">
          Carregando lista...
        </div>
      </div>
    </div>

    <script>
      // URL do backend no Render
      const API = "https://dashboard-vendas1.onrender.com/api";

      let token = null;
      let nomeVendedora = null;
      let isGerente = false;

      // vari√°veis para indicadores
      let vendasHojeQtd = 0;
      let vendasHojeTotal = 0;
      let vendasHojePecasTotal = 0;
      let atendimentosHojeQtd = 0;
      let metaHojeValor = 0;
      let metaMensalValor = 0;

      let vendasHojeDados = [];
      let vendaEditandoId = null;

      function hojeISO() {
        return new Date().toISOString().slice(0, 10);
      }

      function setStatus(msg, tipo) {
        const bar = document.getElementById("statusContainer");
        const text = document.getElementById("statusText");
        text.textContent = msg;
        bar.classList.remove("erro", "sucesso");
        if (tipo === "erro") bar.classList.add("erro");
        if (tipo === "sucesso") bar.classList.add("sucesso");
      }

      function abrirAba(qual) {
        const abaVendas = document.getElementById("abaVendas");
        const abaCond = document.getElementById("abaCondicionais");
        const tabV = document.getElementById("tabVendas");
        const tabC = document.getElementById("tabCondicionais");

        if (qual === "vendas") {
          abaVendas.style.display = "block";
          abaCond.style.display = "none";
          tabV.classList.add("active");
          tabC.classList.remove("active");
        } else {
          abaVendas.style.display = "none";
          abaCond.style.display = "block";
          tabV.classList.remove("active");
          tabC.classList.add("active");
        }
      }

      function authHeaders() {
        return {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token,
        };
      }

      function atualizarMetaBarra() {
        const inner = document.getElementById("metaProgressInner");
        const linha = document.getElementById("metaStatusLinha");

        if (!metaHojeValor || metaHojeValor <= 0) {
          inner.style.width = "0%";
          linha.textContent =
            "Defina uma meta di√°ria para acompanhar o progresso.";
          return;
        }

        const perc = Math.min(
          300,
          (vendasHojeTotal / metaHojeValor) * 100
        ); // limite 300%
        inner.style.width = perc.toFixed(1) + "%";

        const falta = metaHojeValor - vendasHojeTotal;

        if (falta > 0) {
          linha.textContent =
            "Voc√™ j√° fez R$ " +
            vendasHojeTotal.toFixed(2) +
            " ‚Äî faltam R$ " +
            falta.toFixed(2) +
            " para bater a meta de hoje.";
        } else if (falta === 0) {
          linha.textContent =
            "Meta di√°ria batida em cheio! R$ " +
            vendasHojeTotal.toFixed(2) +
            " no dia. üéâ";
        } else {
          linha.textContent =
            "Voc√™ passou da meta di√°ria em R$ " +
            Math.abs(falta).toFixed(2) +
            "! Total do dia: R$ " +
            vendasHojeTotal.toFixed(2) +
            ".";
        }
      }

      function atualizarIndicadoresVenda() {
        const ticketSpan = document.getElementById("ticketMedioLinha");
        const taxaSpan = document.getElementById("taxaConversaoLinha");
        const pecasVendaSpan = document.getElementById(
          "pecasPorVendaLinha"
        );
        const pecasAtendSpan = document.getElementById(
          "pecasPorAtendimentoLinha"
        );

        const ticket = vendasHojeQtd
          ? vendasHojeTotal / vendasHojeQtd
          : 0;
        ticketSpan.textContent =
          "Ticket m√©dio: R$ " + ticket.toFixed(2);

        let taxa = 0;
        if (atendimentosHojeQtd && vendasHojeQtd) {
          taxa = (vendasHojeQtd / atendimentosHojeQtd) * 100;
        }
        taxaSpan.textContent =
          "Taxa de convers√£o: " +
          taxa.toFixed(1).replace(".", ",") +
          "%";

        const pecasPorVenda = vendasHojeQtd
          ? vendasHojePecasTotal / vendasHojeQtd
          : 0;
        pecasVendaSpan.textContent =
          "Pe√ßas por venda: " + pecasPorVenda.toFixed(1);

        const pecasPorAtend = atendimentosHojeQtd
          ? vendasHojePecasTotal / atendimentosHojeQtd
          : 0;
        pecasAtendSpan.textContent =
          "Pe√ßas por atendimento: " + pecasPorAtend.toFixed(1);

        atualizarMetaBarra();
      }

      function agruparFormaPagamento(codigo) {
        if (!codigo) return "Outros";
        if (codigo === "dinheiro") return "Dinheiro";
        if (codigo === "pix") return "PIX";
        if (codigo === "debito") return "D√©bito";
        if (codigo.startsWith("credito_")) return "Cr√©dito";
        if (codigo.startsWith("crediario_")) return "Credi√°rio";
        if (codigo.startsWith("boleto_")) return "Boleto";
        if (codigo.startsWith("cheque_")) return "Cheque pr√©";
        return codigo;
      }

      async function login() {
        const nome = document.getElementById("nome").value.trim();
        const senha = document.getElementById("senha").value;

        if (!nome || !senha) {
          setStatus("Preencha nome e senha para entrar.", "erro");
          return;
        }

        setStatus("Conectando...", null);

        try {
          const resp = await fetch(API + "/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nome, senha }),
          });

          if (!resp.ok) {
            setStatus("Falha no login. Confira nome e senha.", "erro");
            return;
          }

          const data = await resp.json();
          token = data.token;
          nomeVendedora = data.vendedora?.nome || nome;
          isGerente = data.vendedora?.isGerente === true;

          document.getElementById("loginCard").style.display = "none";
          document.getElementById("painel").style.display = "grid";

          const hojeFormatado = new Date().toLocaleDateString("pt-BR", {
            weekday: "long",
            day: "2-digit",
            month: "long",
            year: "numeric",
          });

          document.getElementById("bemVindaTitulo").textContent =
            "Bom dia, " + nomeVendedora;
          document.getElementById("infoHoje").textContent =
            hojeFormatado.charAt(0).toUpperCase() +
            hojeFormatado.slice(1);

          if (isGerente) {
            document.getElementById("cardGerencia").style.display = "block";
            carregarVendedoras();
            setStatus(
              `Logada como ${nomeVendedora} (GERENTE).`,
              "sucesso"
            );
          } else {
            setStatus(`Logada como ${nomeVendedora}.`, "sucesso");
          }

          // carregar meta mensal salva no navegador
          carregarMetaMensalLocal();

          await Promise.all([
            carregarMetaHoje(),
            carregarAtendimentosHoje(),
            carregarVendasHoje(),
            carregarCondicionais(),
          ]);

          // calcular resumo mensal depois de carregar vendas
          calcularResumoMetaMensal().catch(() => {});
        } catch (e) {
          console.error(e);
          setStatus("Erro ao conectar com o servidor.", "erro");
        }
      }

      // META DI√ÅRIA
      async function carregarMetaHoje() {
        if (!token) return;
        const data = hojeISO();
        const resp = await fetch(API + "/metas/" + data, {
          headers: { Authorization: "Bearer " + token },
        });
        const meta = await resp.json();
        const valor = Number(meta.valor_meta || meta.valorMeta || 0);
        metaHojeValor = valor;
        document.getElementById("metaAtual").textContent =
          "R$ " + valor.toFixed(2);
        document.getElementById("metaValor").value =
          valor > 0 ? valor.toString() : "";
        atualizarMetaBarra();
      }

      async function salvarMetaHoje() {
        if (!token) return;
        const valor = Number(
          (document.getElementById("metaValor").value || "0").replace(
            ",",
            "."
          )
        );
        const data = hojeISO();

        try {
          const resp = await fetch(API + "/metas", {
            method: "POST",
            headers: authHeaders(),
            body: JSON.stringify({ valorMeta: valor, data }),
          });

          if (!resp.ok) {
            setStatus("N√£o foi poss√≠vel salvar a meta di√°ria.", "erro");
            return;
          }

          await carregarMetaHoje();
          setStatus("Meta de hoje atualizada.", "sucesso");
        } catch (e) {
          console.error(e);
          setStatus("Erro ao salvar meta di√°ria.", "erro");
        }
      }

      // META MENSAL (apenas no frontend, salva no localStorage)
      function carregarMetaMensalLocal() {
        const salvo = localStorage.getItem("metaMensalDashboardIMG");
        if (salvo) {
          const v = Number(salvo);
          if (!isNaN(v) && v > 0) {
            metaMensalValor = v;
            const input = document.getElementById("metaMensalValor");
            if (input) input.value = v.toString();
          }
        }
      }

      function salvarMetaMensal() {
        const v = Number(
          (document.getElementById("metaMensalValor").value || "0").replace(
            ",",
            "."
          )
        );
        metaMensalValor = v > 0 ? v : 0;
        localStorage.setItem("metaMensalDashboardIMG", metaMensalValor);
        setStatus("Meta mensal atualizada no painel.", "sucesso");
        calcularResumoMetaMensal().catch(() => {});
      }

      function contarDiasUteisRestantes(hoje) {
        const ano = hoje.getFullYear();
        const mes = hoje.getMonth();
        // come√ßa amanh√£
        let dt = new Date(ano, mes, hoje.getDate() + 1);
        const last = new Date(ano, mes + 1, 0);
        let count = 0;
        while (dt <= last) {
          const dow = dt.getDay(); // 0=domingo, 6=s√°bado
          if (dow !== 0) {
            // trabalhamos de segunda a s√°bado, ent√£o s√≥ exclui domingo
            count++;
          }
          dt.setDate(dt.getDate() + 1);
        }
        return count;
      }

      async function calcularResumoMetaMensal() {
        const resumoEl = document.getElementById("metaMensalResumo");
        const sugestaoEl = document.getElementById("metaMensalSugestao");

        if (!metaMensalValor || metaMensalValor <= 0) {
          resumoEl.textContent = "Nenhuma meta mensal definida.";
          sugestaoEl.textContent = "";
          return;
        }

        if (!token) {
          resumoEl.textContent = "Fa√ßa login para calcular a meta mensal.";
          sugestaoEl.textContent = "";
          return;
        }

        const hoje = new Date();
        const ano = hoje.getFullYear();
        const mes = hoje.getMonth();
        const inicio = new Date(ano, mes, 1).toISOString().slice(0, 10);
        const fim = new Date(ano, mes + 1, 0).toISOString().slice(0, 10);

        try {
          const url =
            API +
            `/vendas?dataInicio=${encodeURIComponent(
              inicio
            )}&dataFim=${encodeURIComponent(fim)}`;
          const resp = await fetch(url, {
            headers: { Authorization: "Bearer " + token },
          });
          const vendas = await resp.json();

          let totalMes = 0;
          vendas.forEach((v) => {
            totalMes += Number(v.valor || 0);
          });

          const falta = metaMensalValor - totalMes;

          resumoEl.textContent =
            "Meta mensal: R$ " +
            metaMensalValor.toFixed(2) +
            " ‚Ä¢ Vendido no m√™s: R$ " +
            totalMes.toFixed(2) +
            " ‚Ä¢ Diferen√ßa: R$ " +
            falta.toFixed(2);

          const diasRest = contarDiasUteisRestantes(hoje);

          if (falta <= 0) {
            sugestaoEl.textContent =
              "Meta mensal j√° batida! Sobra de R$ " +
              Math.abs(falta).toFixed(2) +
              " no m√™s.";
          } else if (diasRest <= 0) {
            sugestaoEl.textContent =
              "N√£o h√° mais dias √∫teis no m√™s para dividir a diferen√ßa.";
          } else {
            const metaDia = falta / diasRest;
            sugestaoEl.textContent =
              "Para bater a meta mensal, precisa vender em m√©dia R$ " +
              metaDia.toFixed(2) +
              " por dia √∫til at√© o fim do m√™s (" +
              diasRest +
              " dia(s)).";
          }
        } catch (e) {
          console.error(e);
          resumoEl.textContent = "Erro ao calcular meta mensal.";
          sugestaoEl.textContent = "";
        }
      }

      // ATENDIMENTOS
      async function carregarAtendimentosHoje() {
        if (!token) return;
        const data = hojeISO();
        const resp = await fetch(API + "/atendimentos/" + data, {
          headers: { Authorization: "Bearer " + token },
        });
        const dados = await resp.json();
        const qtd = Number(dados.quantidade || 0);
        document.getElementById("atendimentosQtd").value = qtd;
        atendimentosHojeQtd = qtd;
        atualizarIndicadoresVenda();
      }

      async function salvarAtendimentosHoje() {
        if (!token) return;
        const quantidade = Number(
          document.getElementById("atendimentosQtd").value || "0"
        );
        const data = hojeISO();

        try {
          const resp = await fetch(API + "/atendimentos", {
            method: "POST",
            headers: authHeaders(),
            body: JSON.stringify({ quantidade, data }),
          });

          if (!resp.ok) {
            setStatus("N√£o foi poss√≠vel salvar atendimentos.", "erro");
            return;
          }

          await carregarAtendimentosHoje();
          setStatus("Atendimentos salvos para hoje.", "sucesso");
        } catch (e) {
          console.error(e);
          setStatus("Erro ao salvar atendimentos.", "erro");
        }
      }

      // VENDAS
      async function carregarVendasHoje() {
        if (!token) return;
        const hoje = hojeISO();
        const url =
          API +
          `/vendas?dataInicio=${encodeURIComponent(
            hoje
          )}&dataFim=${encodeURIComponent(hoje)}`;

        try {
          const resp = await fetch(url, {
            headers: { Authorization: "Bearer " + token },
          });
          const vendas = await resp.json();
          vendasHojeDados = vendas;

          const tbody = document.querySelector("#tabelaVendas tbody");
          tbody.innerHTML = "";

          let total = 0;
          let totalPecas = 0;
          const totaisForma = {};

          vendas.forEach((v) => {
            const tr = document.createElement("tr");
            const dataVenda = v.data_venda || v.datavenda || v.data;
            const hora = dataVenda
              ? new Date(dataVenda).toLocaleTimeString("pt-BR", {
                  hour: "2-digit",
                  minute: "2-digit",
                })
              : "-";

            const valor = Number(v.valor || 0);
            const pecas = Number(v.quantidade_pecas || 0);
            const forma =
              v.forma_pagamento || v.formaPagamento || "-";
            const formaGrupo = agruparFormaPagamento(forma);

            total += valor;
            totalPecas += pecas;

            if (!totaisForma[formaGrupo]) totaisForma[formaGrupo] = 0;
            totaisForma[formaGrupo] += valor;

            tr.innerHTML = `
              <td>${hora}</td>
              <td>${v.cliente_nome || v.clienteNome || "-"}</td>
              <td>${forma}</td>
              <td>${pecas || "-"}</td>
              <td>R$ ${valor.toFixed(2)}</td>
              <td>
                <button
                  class="btn-outline"
                  style="padding:4px 8px;font-size:10px"
                  onclick="prepararEdicaoVenda(${v.id})"
                >
                  Editar
                </button>
                <button
                  class="btn-danger"
                  style="padding:4px 8px;font-size:10px;margin-left:4px"
                  onclick="deletarVenda(${v.id})"
                >
                  Excluir
                </button>
              </td>
            `;
            tbody.appendChild(tr);
          });

          vendasHojeQtd = vendas.length;
          vendasHojeTotal = total;
          vendasHojePecasTotal = totalPecas;

          if (vendas.length === 0) {
            document.getElementById("resumoVendasHoje").textContent =
              "Nenhuma venda lan√ßada hoje.";
          } else {
            document.getElementById(
              "resumoVendasHoje"
            ).textContent = `${vendas.length} venda(s) ‚Ä¢ Total R$ ${total.toFixed(
              2
            )} ‚Ä¢ Pe√ßas: ${totalPecas}`;
          }

          // Totais por forma de pagamento
          const totaisEl = document.getElementById(
            "totaisFormaPagamento"
          );
          const chaves = Object.keys(totaisForma);
          if (chaves.length === 0) {
            totaisEl.textContent =
              "Totais por forma de pagamento: ‚Äî";
          } else {
            const partes = chaves.map(
              (k) => `${k}: R$ ${totaisForma[k].toFixed(2)}`
            );
            totaisEl.textContent =
              "Totais por forma de pagamento: " +
              partes.join(" ‚Ä¢ ");
          }

          atualizarIndicadoresVenda();
        } catch (e) {
          console.error(e);
          setStatus("Erro ao buscar vendas de hoje.", "erro");
        }
      }

      async function lancarVenda() {
        if (!token) return;

        const valor = Number(
          (document.getElementById("valorVenda").value || "0").replace(
            ",",
            "."
          )
        );
        const quantidadePecas = Number(
          document.getElementById("qtdPecasVenda").value || "0"
        );
        const formaPagamento =
          document.getElementById("formaPagamento").value;
        const clienteNome = document
          .getElementById("clienteNome")
          .value.trim();
        const observacao = document
          .getElementById("obsVenda")
          .value.trim();

        if (!valor || !formaPagamento) {
          setStatus(
            "Informe pelo menos o valor e a forma de pagamento.",
            "erro"
          );
          return;
        }

        const body = {
          valor,
          formaPagamento,
          clienteNome,
          observacao,
          quantidadePecas,
        };

        let url = API + "/vendas";
        let method = "POST";

        if (vendaEditandoId) {
          url = API + "/vendas/" + vendaEditandoId;
          method = "PUT";
        }

        try {
          const resp = await fetch(url, {
            method,
            headers: authHeaders(),
            body: JSON.stringify(body),
          });

          if (!resp.ok) {
            setStatus("N√£o foi poss√≠vel salvar a venda.", "erro");
            return;
          }

          document.getElementById("valorVenda").value = "";
          document.getElementById("qtdPecasVenda").value = "";
          document.getElementById("formaPagamento").value = "";
          document.getElementById("clienteNome").value = "";
          document.getElementById("obsVenda").value = "";
          vendaEditandoId = null;

          setStatus("Venda salva com sucesso.", "sucesso");
          await carregarVendasHoje();
          calcularResumoMetaMensal().catch(() => {});
        } catch (e) {
          console.error(e);
          setStatus("Erro ao salvar venda.", "erro");
        }
      }

      function prepararEdicaoVenda(id) {
        const v = vendasHojeDados.find((x) => x.id === id);
        if (!v) return;

        vendaEditandoId = id;

        document.getElementById("valorVenda").value = Number(
          v.valor || 0
        ).toString();
        document.getElementById("qtdPecasVenda").value = v.quantidade_pecas
          ? Number(v.quantidade_pecas).toString()
          : "";
        document.getElementById("formaPagamento").value =
          v.forma_pagamento || v.formaPagamento || "";
        document.getElementById("clienteNome").value =
          v.cliente_nome || v.clienteNome || "";
        document.getElementById("obsVenda").value = v.observacao || "";

        setStatus(
          "Editando venda selecionada. Ajuste os dados e clique em 'Lan√ßar venda' para salvar.",
          "sucesso"
        );
      }

      async function deletarVenda(id) {
        if (!token) return;
        if (!confirm("Deseja remover esta venda?")) return;

        try {
          const resp = await fetch(API + "/vendas/" + id, {
            method: "DELETE",
            headers: { Authorization: "Bearer " + token },
          });

          if (!resp.ok) {
            setStatus("N√£o foi poss√≠vel remover a venda.", "erro");
            return;
          }

          setStatus("Venda removida.", "sucesso");
          if (vendaEditandoId === id) vendaEditandoId = null;
          await carregarVendasHoje();
          calcularResumoMetaMensal().catch(() => {});
        } catch (e) {
          console.error(e);
          setStatus("Erro ao remover venda.", "erro");
        }
      }

      // CONDICIONAIS
      async function carregarCondicionais() {
        if (!token) return;

        try {
          const resp = await fetch(API + "/condicionais", {
            headers: { Authorization: "Bearer " + token },
          });
          const conds = await resp.json();

          const tbody = document.querySelector(
            "#tabelaCondicionais tbody"
          );
          tbody.innerHTML = "";

          conds.forEach((c) => {
            const tr = document.createElement("tr");
            const dataReg = c.data_registro || c.dataRegistro;
            const data = dataReg
              ? new Date(dataReg).toLocaleDateString("pt-BR")
              : "-";

            tr.innerHTML = `
              <td>${data}</td>
              <td>${c.cliente_nome || c.clienteNome}</td>
              <td>${c.quantidade_pecas || c.quantidadePecas}</td>
              <td>R$ ${Number(
                c.valor_total || c.valorTotal || 0
              ).toFixed(2)}</td>
              <td><button class="btn-danger" onclick="deletarCondicional(${
                c.id
              })">Remover</button></td>
            `;
            tbody.appendChild(tr);
          });
        } catch (e) {
          console.error(e);
          setStatus("Erro ao buscar condicionais.", "erro");
        }
      }

      async function lancarCondicional() {
        if (!token) return;

        const quantidadePecas = Number(
          document.getElementById("qtdPecas").value || "0"
        );
        const valorTotal = Number(
          (document
            .getElementById("valorCondicional")
            .value.replace(",", ".") || "0")
        );
        const clienteNome = document
          .getElementById("clienteCondicional")
          .value.trim();
        const observacao = document
          .getElementById("obsCondicional")
          .value.trim();

        if (!quantidadePecas || !clienteNome) {
          setStatus(
            "Informe ao menos a quantidade de pe√ßas e o nome da cliente.",
            "erro"
          );
          return;
        }

        try {
          const resp = await fetch(API + "/condicionais", {
            method: "POST",
            headers: authHeaders(),
            body: JSON.stringify({
              quantidadePecas,
              valorTotal,
              clienteNome,
              observacao,
            }),
          });

          if (!resp.ok) {
            setStatus("N√£o foi poss√≠vel lan√ßar o condicional.", "erro");
            return;
          }

          document.getElementById("qtdPecas").value = "";
          document.getElementById("valorCondicional").value = "";
          document.getElementById("clienteCondicional").value = "";
          document.getElementById("obsCondicional").value = "";

          setStatus("Condicional lan√ßado com sucesso.", "sucesso");
          await carregarCondicionais();
        } catch (e) {
          console.error(e);
          setStatus("Erro ao lan√ßar condicional.", "erro");
        }
      }

      async function deletarCondicional(id) {
        if (!token) return;
        if (!confirm("Remover este condicional?")) return;

        try {
          const resp = await fetch(API + "/condicionais/" + id, {
            method: "DELETE",
            headers: { Authorization: "Bearer " + token },
          });

          if (!resp.ok) {
            setStatus("N√£o foi poss√≠vel remover o condicional.", "erro");
            return;
          }

          setStatus("Condicional removido.", "sucesso");
          await carregarCondicionais();
        } catch (e) {
          console.error(e);
          setStatus("Erro ao remover condicional.", "erro");
        }
      }

      // GER√äNCIA
      async function carregarVendedoras() {
        if (!token || !isGerente) return;

        try {
          const resp = await fetch(API + "/vendedoras", {
            headers: { Authorization: "Bearer " + token },
          });
          if (!resp.ok) {
            document.getElementById("listaVendedoras").textContent =
              "N√£o foi poss√≠vel carregar as vendedoras.";
            return;
          }

          const lista = await resp.json();
          if (!Array.isArray(lista) || lista.length === 0) {
            document.getElementById("listaVendedoras").textContent =
              "Nenhuma vendedora cadastrada ainda.";
            return;
          }

          const linhas = lista.map((v) => {
            return (
              v.nome +
              (v.is_gerente || v.isGerente ? " (gerente)" : "")
            );
          });

          document.getElementById("listaVendedoras").textContent =
            linhas.join(" ‚Ä¢ ");
        } catch (e) {
          console.error(e);
          document.getElementById("listaVendedoras").textContent =
            "Erro ao carregar vendedoras.";
        }
      }

      async function cadastrarVendedora() {
        if (!token || !isGerente) return;

        const nome = document
          .getElementById("novaVendedoraNome")
          .value.trim();
        const senha = document.getElementById("novaVendedoraSenha").value;
        const isGer = document.getElementById(
          "novaVendedoraGerente"
        ).checked;

        if (!nome || !senha) {
          setStatus(
            "Para cadastrar, preencha nome e senha da vendedora.",
            "erro"
          );
          return;
        }

        try {
          const resp = await fetch(API + "/vendedoras", {
            method: "POST",
            headers: authHeaders(),
            body: JSON.stringify({
              nome,
              senha,
              isGerente: isGer,
            }),
          });

          if (!resp.ok) {
            const erro = await resp.json().catch(() => ({}));
            setStatus(
              erro.erro || "N√£o foi poss√≠vel cadastrar a vendedora.",
              "erro"
            );
            return;
          }

          document.getElementById("novaVendedoraNome").value = "";
          document.getElementById("novaVendedoraSenha").value = "";
          document.getElementById("novaVendedoraGerente").checked = false;

          setStatus("Vendedora cadastrada com sucesso.", "sucesso");
          await carregarVendedoras();
        } catch (e) {
          console.error(e);
          setStatus("Erro ao cadastrar vendedora.", "erro");
        }
      }

      // Carrega meta mensal do localStorage ao abrir a p√°gina
      document.addEventListener("DOMContentLoaded", () => {
        carregarMetaMensalLocal();
      });
    </script>
  </body>
</html>
